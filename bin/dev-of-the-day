#!/usr/bin/env ruby
require 'slack'
require 'json'

pagerduty_token = CDO.pagerduty_token
slack_token = CDO.slack_token
slack_pagerduty_webhook = CDO.slack_pagerduty_webhook

# Get DOTD on call from Pager Duty
on_call = `curl -H "Content-type: application/json" -H "Authorization: Token token=#{pagerduty_token}" -X GET -G "https://codeorg.pagerduty.com/api/v1/users/on_call"`
dotd_name = JSON.parse(on_call)["users"].first["name"]
dotd_email = JSON.parse(on_call)["users"].first["email"]

# Match Pager Duty email to Slack name
client = Slack::Client.new token: slack_token
users = Hash[client.users_list["members"].map{|m| [m["name"], m["profile"]["email"]]}]
users.each_pair { |name, email| dotd_name = name if dotd_email.eql? email }

# Post the DOTD in the developers channel
`curl -X POST --data-urlencode 'payload={"channel": "#developers", "username": "pagerdutybot", "text": "<@#{dotd_name}> is dev of the day", "icon_emoji": ":pager:"}' #{slack_pagerduty_webhook}`
