#!/usr/bin/env ruby

require_relative '../mailing-common/mailing-list-utils'

PEGASUS_REPORTING_DB_READONLY = sequel_connect(
  CDO.pegasus_reporting_db_reader,
  CDO.pegasus_reporting_db_reader
)

# EMAIL 1 (csf_pd): Code Studio teachers who attended a K5 PD.
query_1_csf_pd = "
  SELECT email
  FROM contact_rollups
  WHERE opted_out IS NULL
    AND roles LIKE '%Teacher%'
    AND professional_learning_attended LIKE '%CS Fundamentals%'
"
results_1_csf_pd = {}
PEGASUS_REPORTING_DB_READONLY.fetch(query_1_csf_pd).
  reject {|row| UNSUBSCRIBERS.include? row[:email]}.
  each do |row|
  results_1_csf_pd[row[:email]] = {email: row[:email]}
end

puts "LIST 1 (CSF PD) SIZE: #{results_1_csf_pd.size}."
export_contacts_to_csv results_1_csf_pd, 'email_1_csf_pd.csv'

# EMAIL 2: Code Studio teachers in (US or unknown location) and
#   (sections where grade is K5 or ages of students taught is 4 to 11)
# minus EMAIL 1.

query_2_csf_no_pd = "
  SELECT email
  FROM contact_rollups
  WHERE opted_out IS NULL
    AND roles LIKE '%Teacher%'
    AND (country = 'United States' OR country IS NULL)
    AND (
      (
        grades_taught LIKE '%K%'
          OR grades_taught LIKE '%,1,%' OR grades_taught = '1' OR grades_taught LIKE '1,%' OR grades_taught LIKE '%,1'
          OR grades_taught LIKE '%,2,%' OR grades_taught = '2' OR grades_taught LIKE '2,%' OR grades_taught LIKE '%,2'
          OR grades_taught LIKE '%,3,%' OR grades_taught = '3' OR grades_taught LIKE '3,%' OR grades_taught LIKE '%,3'
          OR grades_taught LIKE '%,4,%' OR grades_taught = '4' OR grades_taught LIKE '4,%' OR grades_taught LIKE '%,4'
          OR grades_taught LIKE '%,5,%' OR grades_taught = '5' OR grades_taught LIKE '5,%' OR grades_taught LIKE '%,5'
      ) OR (
        ages_taught LIKE '%,4,%' OR ages_taught = '4' OR ages_taught LIKE '4,%' OR ages_taught LIKE '%,4'
          OR ages_taught LIKE '%,5,%' OR ages_taught = '5' OR ages_taught LIKE '5,%' OR ages_taught LIKE '%,5'
          OR ages_taught LIKE '%,6,%' OR ages_taught = '6' OR ages_taught LIKE '6,%' OR ages_taught LIKE '%,6'
          OR ages_taught LIKE '%,7,%' OR ages_taught = '7' OR ages_taught LIKE '7,%' OR ages_taught LIKE '%,7'
          OR ages_taught LIKE '%,8,%' OR ages_taught = '8' OR ages_taught LIKE '8,%' OR ages_taught LIKE '%,8'
          OR ages_taught LIKE '%,9,%' OR ages_taught = '9' OR ages_taught LIKE '9,%' OR ages_taught LIKE '%,9'
          OR ages_taught LIKE '%,10,%' OR ages_taught = '10' OR ages_taught LIKE '10,%' OR ages_taught LIKE '%,10'
          OR ages_taught LIKE '%,11,%' OR ages_taught = '11' OR ages_taught LIKE '11,%' OR ages_taught LIKE '%,11'
      )
    )
"
results_2_csf_no_pd = {}
PEGASUS_REPORTING_DB_READONLY.fetch(query_2_csf_no_pd).
  reject {|row| UNSUBSCRIBERS.include? row[:email]}.
  reject {|row| results_1_csf_pd.key? row[:email]}.
  each do |row|
  results_2_csf_no_pd[row[:email]] = {email: row[:email]}
end

puts "LIST 2 (CSF NO PD) SIZE: #{results_2_csf_no_pd.size}."
export_contacts_to_csv results_2_csf_no_pd, 'email_2_csf_no_pd.csv'
# Split up for 2 A/B test formats at 10% each, leaving 80% for the final mail.
puts `../mailing-common/split ./email_2_csf_no_pd.csv #{' 10' * 2}`

# EMAIL 3: Code Studio teachers in (US or unknown location) and
#   (sections where grade is 9 to 12 or ages of students taught is 14 to 18)
# minus EMAIL 1 and EMAIL 2.

query_3_csp = "
  SELECT email
  FROM contact_rollups
  WHERE opted_out IS NULL
    AND roles LIKE '%Teacher%'
    AND (country = 'United States' OR country IS NULL)
    AND (
      (
        grades_taught LIKE '%,9,%' OR grades_taught = '9' OR grades_taught LIKE '9,%' OR grades_taught LIKE '%,9'
          OR grades_taught LIKE '%,10,%' OR grades_taught = '10' OR grades_taught LIKE '10,%' OR grades_taught LIKE '%,10'
          OR grades_taught LIKE '%,11,%' OR grades_taught = '11' OR grades_taught LIKE '11,%' OR grades_taught LIKE '%,11'
          OR grades_taught LIKE '%,12,%' OR grades_taught = '12' OR grades_taught LIKE '12,%' OR grades_taught LIKE '%,12'
      ) OR (
        ages_taught LIKE '%,14,%' OR ages_taught = '14' OR ages_taught LIKE '14,%' OR ages_taught LIKE '%,14'
          OR ages_taught LIKE '%,15,%' OR ages_taught = '15' OR ages_taught LIKE '15,%' OR ages_taught LIKE '%,15'
          OR ages_taught LIKE '%,16,%' OR ages_taught = '16' OR ages_taught LIKE '16,%' OR ages_taught LIKE '%,16'
          OR ages_taught LIKE '%,17,%' OR ages_taught = '17' OR ages_taught LIKE '17,%' OR ages_taught LIKE '%,17'
          OR ages_taught LIKE '%,18,%' OR ages_taught = '18' OR ages_taught LIKE '18,%' OR ages_taught LIKE '%,18'
      )
    )
"
results_3_csp = {}
PEGASUS_REPORTING_DB_READONLY.fetch(query_3_csp).
  reject {|row| UNSUBSCRIBERS.include? row[:email]}.
  reject {|row| results_1_csf_pd.key?(row[:email]) || results_2_csf_no_pd.key?(row[:email])}.
  each do |row|
  results_3_csp[row[:email]] = {email: row[:email]}
end

puts "LIST 3 (CSP) SIZE: #{results_3_csp.size}."
export_contacts_to_csv results_3_csp, 'email_3_csp.csv'

# EMAIL 4: Code Studio teachers in (US or unknown location) and
#   (sections where grade is 6 to 8 or ages of students taught is 12 to 13)
# minus EMAIL 1 and EMAIL 2 and EMAIL 3.

query_4_csd = "
  SELECT email
  FROM contact_rollups
  WHERE opted_out IS NULL
    AND roles LIKE '%Teacher%'
    AND (country = 'United States' OR country IS NULL)
    AND (
      (
        grades_taught LIKE '%,6,%' OR grades_taught = '6' OR grades_taught LIKE '6,%' OR grades_taught LIKE '%,6'
          OR grades_taught LIKE '%,7,%' OR grades_taught = '7' OR grades_taught LIKE '7,%' OR grades_taught LIKE '%,7'
          OR grades_taught LIKE '%,8,%' OR grades_taught = '8' OR grades_taught LIKE '8,%' OR grades_taught LIKE '%,8'
      ) OR (
        ages_taught LIKE '%,12,%' OR ages_taught = '12' OR ages_taught LIKE '12,%' OR ages_taught LIKE '%,12'
          OR ages_taught LIKE '%,13,%' OR ages_taught = '13' OR ages_taught LIKE '13,%' OR ages_taught LIKE '%,13'
      )
    )
"
results_4_csd = {}
PEGASUS_REPORTING_DB_READONLY.fetch(query_4_csd).
  reject {|row| UNSUBSCRIBERS.include? row[:email]}.
  reject {|row| results_1_csf_pd.key?(row[:email]) || results_2_csf_no_pd.key?(row[:email]) || results_3_csp.key?(row[:email])}.
  each do |row|
  results_4_csd[row[:email]] = {email: row[:email]}
end

puts "LIST 4 (CSD) SIZE: #{results_4_csd.size}."
export_contacts_to_csv results_4_csd, 'email_4_csd.csv'

# EMAIL 5: Code Studio teachers in (US or unknown location)
# minus EMAIL 1 and EMAIL 2 and EMAIL 3 and EMAIL 4.

query_5_unknown = "
  SELECT email
  FROM contact_rollups
  WHERE opted_out IS NULL
    AND roles LIKE '%Teacher%'
    AND (country = 'United States' OR country IS NULL)
"
results_5_unknown = {}
PEGASUS_REPORTING_DB_READONLY.fetch(query_5_unknown).
  reject {|row| UNSUBSCRIBERS.include? row[:email]}.
  reject {|row| results_1_csf_pd.key?(row[:email]) || results_2_csf_no_pd.key?(row[:email]) || results_3_csp.key?(row[:email]) || results_4_csd.key?(row[:email])}.
  each do |row|
  results_5_unknown[row[:email]] = {email: row[:email]}
end

puts "LIST 5 (UNKNOWN) SIZE: #{results_5_unknown.size}."
export_contacts_to_csv results_5_unknown, 'email_5_unknown.csv'

# EMAIL 6: Code Studio teachers
# minus EMAIL 1 and EMAIL 2 and EMAIL 3 and EMAIL 4 and EMAIL 5.

query_6_international = "
  SELECT email
  FROM contact_rollups
  WHERE opted_out IS NULL
    AND roles LIKE '%Teacher%'
"
results_6_international = {}
PEGASUS_REPORTING_DB_READONLY.fetch(query_6_international).
  reject {|row| UNSUBSCRIBERS.include? row[:email]}.
  reject {|row| results_1_csf_pd.key?(row[:email]) || results_2_csf_no_pd.key?(row[:email]) || results_3_csp.key?(row[:email]) || results_4_csd.key?(row[:email]) || results_5_unknown.key?(row[:email])}.
  each do |row|
  results_6_international[row[:email]] = {email: row[:email]}
end

puts "LIST 6 (INTERNATIONAL) SIZE: #{results_6_international.size}."
export_contacts_to_csv results_6_international, 'email_6_international.csv'
