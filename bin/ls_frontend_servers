#!/usr/bin/env ruby
#
# Script to list the name, public DNS name, and private DNS name of
# each running AWS frontend instance.

require 'aws-sdk'
require_relative '../deployment'

# Returns an array of [name, private_dns, public_url] tuples.
def describe_frontends
  ec2client = Aws::EC2::Client.new
  instances = ec2client.describe_instances
  [].tap do |result|
    instances.reservations.each do |reservation|
      reservation.instances.each do |instance|
        name = instance.tags.detect{|tag| tag.key == 'Name'}
        next unless name.value.start_with? "frontend"
        result <<  [(name ? name.value : '').ljust(16),
                    instance.private_dns_name,
                    "http://#{instance.public_dns_name}:8080"]
      end
    end
  end
end

if __FILE__ == $0
  for t in describe_frontends
    puts t.join("\t")
  end
end
