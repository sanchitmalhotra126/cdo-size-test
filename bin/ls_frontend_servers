#!/usr/bin/env ruby
#
# Script to list the name, public DNS name, and private DNS name of
# each running AWS frontend instance.

require 'aws-sdk'
require_relative '../deployment'
require 'etc'
require 'net/ssh'
require 'net/scp'
require 'io/console'
require 'json'
require 'set'

def ls_servers
  ec2client = Aws::EC2::Client.new

  instances = ec2client.describe_instances

  instances.reservations.each do |reservation|
    reservation.instances.each do |instance|
      name = instance.tags.detect{|tag| tag.key == 'Name'}
      next unless name.value.start_with? "frontend"

      public_url = "http://#{instance.public_dns_name}:8080"
      puts [name ? name.value : '',
            instance.private_dns_name,
            public_url].join("\t")
    end
  end
end

ls_servers
