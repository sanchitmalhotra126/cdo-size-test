#!/usr/bin/env ruby

#
# Script to remove race data from users who might have been affected by the
# geolocation bug.
#

require_relative '../../../dashboard/config/environment'

# We specifically care about users that:
# 1. Have race data and
# 2. Have either:
#     a. a blank geoloc (cleared out in FND-592) or
#     b. have been geolocated to outside the US (they've been re-geolocated
#     since their IP/geoloc was cleared out in FND-592).
have_race = User.with_deleted.includes(:user_geos).where.not(races: nil)

affected_users = have_race.
  where(user_geos: {id: nil}).
  or(have_race.where.not(user_geos: {country: "United States"}))

affected_users.all.each do |user|
  # we can ignore users who have not signed in since
  # https://github.com/code-dot-org/code-dot-org/pull/28635 was merged.
  old_account = user.current_sign_in_at.present? && user.current_sign_in_at < "2019-05-17T23:39:33Z".to_datetime
  next if old_account

  # Of the users (mostly students) with URM data but no geolocation, about 60%
  # are in a section of a teacher in the US. So: Let's KEEP race data for
  # students with _teachers_ whose geolocation is in the US OR with teachers
  # who are associated with a school in the US, so that we can reduce the
  # proportion of students with data we're wiping from 13% to 8%.
  has_us_teacher = user.student? &&
    user.teachers.any? do |teacher|
      teacher.within_united_states? || teacher.user_school_infos.any? {|usi| usi.school_info.usa?}
    end

  next if has_us_teacher

  user.races = nil
  user.save!
  puts("user #{user.id} - success")
rescue
  puts("user #{user.id} - ERROR - other")
end
