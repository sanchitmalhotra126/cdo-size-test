#!/usr/bin/env ruby

# This script removes the 'survey2016_' prefix from the keys in the JSON
# SurveyResult.properties hash for SurveyResult's of kind DiversitySurvey2016.

require_relative '../../../dashboard/config/environment'

PREFIX_TO_REMOVE = 'survey2016_'.freeze

SurveyResult.
  where(kind: SurveyResult::DIVERSITY_2016).
  find_each do |survey_result|
  # The keys to transform are stored in the properties hash.
  properties = survey_result.properties
  transformed_properties = {}
  properties.each do |key, value|
    unless key.start_with? PREFIX_TO_REMOVE
      raise "Found unexpected key: (#{key}, #{value}) in #{survey_result.id}."
    end
    transformed_properties[key.gsub(PREFIX_TO_REMOVE, '')] = value
  end
  survey_result.properties = transformed_properties
  survey_result.save!
end
