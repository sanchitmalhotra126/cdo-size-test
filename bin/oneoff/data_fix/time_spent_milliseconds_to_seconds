#!/usr/bin/env ruby

require_relative '../../../dashboard/config/environment'

# The time_spent field in the user_levels table has been
# recording time in milliseconds. This will cause time_spent
# to max out at ~25 days. Instead we want to record time in
# seconds. This will cause time_spent to max out at ~68 years
#
# Relevant entries include:
# SELECT *
# FROM user_levels
# WHERE time_spent IS NOT NULL
#   AND time_spent > 0;
#
# time_spent should be transformed as such
# (time_spent.to_f/1000).ceil.to_i

# upper limit: 2811329000;
# lower limit:   93221000;

slice = 0

UserLevel.find_in_batches(start: 93_221_000, finish: 2_811_329_000, batch_size: 5000) do |user_level_slice|
  puts "PROCESSING: slice #{slice} with starting id #{user_level_slice.first.id}."
  ActiveRecord::Base.transaction do
    user_level_slice.each do |user_level|
      if user_level.time_spent && user_level.time_spent > 0
        user_level.time_spent = (user_level.time_spent.to_f / 1000).ceil.to_i
        user_level.save(touch: false, validate: false)
      end
    end
  end
  puts "PROCESSED: slice: #{slice}."
  slice += 1
end
