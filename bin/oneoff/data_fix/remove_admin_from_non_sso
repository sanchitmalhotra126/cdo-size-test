#!/usr/bin/env ruby

#
# Script to remove admin privileges from accounts without Google SSO
#

require_relative '../../../dashboard/config/environment'

File.readlines(ARGV[0]).each do |line|
  id = line.to_i
  user = User.find_by_id(id)
  if user.nil?
    puts("user #{id} - ERROR - does not exist")
    next
  end

  unless user.admin
    puts("user #{id} - ERROR - is not admin")
    next
  end

  if user.
      authentication_options.
      where(credential_type: "google_oauth2").
      where("email LIKE ?", '%@code.org').
      exists?
    puts("user #{id} - SKIPPING - has code.org SSO credentials")
    next
  end

  user.admin = false
  user.save!
  puts("user #{id} - success")
rescue
  puts("user #{id} - ERROR - other")
end
