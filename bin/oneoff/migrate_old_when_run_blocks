#!/usr/bin/env ruby

# This script replaces instances of "flappy_whenRunButtonClick" within
# level_sources.data with "when_run". Doing so obsoletes the method
# LevelSource#replace_old_when_run_blocks.

# It reads a CSV for a list of LevelSource IDs to fix, generated by the SQL
#
#   SELECT id
#   FROM level_sources
#   WHERE level_id IN (
#     SELECT id
#     FROM levels
#     WHERE game_id = (SELECT id FROM games WHERE name = "Flappy")
#   );
#
# noting that adding the clause
#
#   AND data LIKE '%flappy_whenRunButtonClick%'
#
# to the query caused it to become prohibitively long (longer than four hours).

require 'digest/md5'
require_relative '../../dashboard/config/environment'

DATA_FILE = ARGV[0].freeze
OLD_WHEN_RUN = 'flappy_whenRunButtonClick'.freeze
NEW_WHEN_RUN = 'when_run'.freeze

rows_processed = 0
rows_fixed = 0

begin
  CSV.foreach(DATA_FILE) do |row|
    rows_processed += 1
    puts "PROCESSED #{rows_processed}..." if rows_processed % 10_000 == 0
    puts "  FIXED #{rows_fixed}..." if rows_fixed % 100 == 1

    level_source_id = row[0]
    level_source = LevelSource.find_by_id(level_source_id)

    next unless level_source.data.include? OLD_WHEN_RUN

    new_data = level_source.data.gsub(OLD_WHEN_RUN, NEW_WHEN_RUN)
    level_source.update!(
      data: new_data,
      md5: Digest::MD5.hexdigest(new_data)
    )

    rows_fixed += 1
  end
rescue Exception => e
  puts "EXCEPTION: #{rows_processed}..."
  raise e
end
