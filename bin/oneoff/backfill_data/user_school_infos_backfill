#!/usr/bin/env ruby

require_relative '../../../dashboard/config/environment'

num_users_updated = 0
batch_size = 10000

puts "Processing..."
User.where.not(school_info: nil).where(user_type: "teacher").find_in_batches(batch_size: batch_size) do |batch|
  ActiveRecord::Base.transaction do
    exceptions = []
    batch.each do |user|
      UserSchoolInfo.create!(
        user_id: user.id,
        school_info_id: user.school_info_id,
        start_date: user.created_at,
        end_date: nil,
        last_confirmation_date: user.created_at
      )
      num_users_updated += 1
    rescue Exception => e
      puts "Error: teacher with user id #{user.id} with school id #{user.school_info.id}"
      exceptions.push(e)
    end
    num_users_updated = 0
    raise ActiveRecord::Rollback, 'Rolledback!' if exceptions.any?
  end
end
# Output how many total users were updated.
puts "\nFinished updating #{num_users_updated} users school information."
