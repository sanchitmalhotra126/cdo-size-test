#!/usr/bin/env ruby
#
# This script creates a user_geos entry (if one does not already exist) for
# every user with a previous sign-in.

require_relative '../../dashboard/config/environment'

if ARGV.length != 1
  puts 'Usage: ./bin/oneoff/back_populate_user_geos start_index'
  exit 1
end
start_index = ARGV[0].to_i

time_now = DateTime.now
User.
  with_deleted.
  where('id >= ?', start_index).
  where.not(current_sign_in_ip: nil).
  find_each do |user|
  # Create a UserGeo record (to be populated by the bin/cron/user_geo cron)
  # unless a record already exists.
  next unless UserGeo.find_by_user_id(user.id).nil?
  UserGeo.create(
    user_id: user.id,
    ip_address: user.current_sign_in_ip,
    created_at: time_now,
    updated_at: time_now
  )
end
