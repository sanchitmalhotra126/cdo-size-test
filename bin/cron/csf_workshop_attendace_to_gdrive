#!/usr/bin/env ruby
require_relative 'only_one'
abort 'Script already running' unless only_one_running?(__FILE__)

require_relative '../../dashboard/config/environment'
require 'cdo/google/sheet'

#
# Uses a Google Cloud service account to write enrollment data for CSF workshops into
# a spreadsheet in Google Drive (with permissions locked down to our organization).
#

EARLIEST_WORKSHOP_END_DATE = Date.new(2020, 6, 1)
LATEST_WORKSHOP_START_DATE = Date.today

def get_rows
  # Seed results array with a header row
  results = [
    [
      "Organizer Name",
      "Organizer Email",
      "Regional Partner Name",
      "Workshop Dates",
      "Funded",
      "Attendance Url",
      "Num Facilitators",
      "Course",
      "Subject",
      "Is this a Virtual Workshop?",
      "Total Hours",
      "Num Registered",
      "Number Scholarship Teachers Attending All Sessions",
      "Attendance Day 1+"
    ]
  ]

  Pd::Workshop.
    where(subject: Pd::SharedWorkshopConstants::SUBJECT_CSF_101).
    scheduled_end_on_or_after(EARLIEST_WORKSHOP_END_DATE).
    scheduled_start_on_or_before(LATEST_WORKSHOP_START_DATE).find_each do |workshop|
      results << [
        workshop.organizer&.name,
        workshop.organizer&.email,
        workshop.regional_partner&.name,
        workshop.sessions.map(&:formatted_date_with_start_and_end_times).join("\n"),
        workshop.funded ? "Yes" : "No",
        attendance_urls(workshop),
        workshop.facilitators.count,
        workshop.course,
        workshop.subject,
        workshop.virtual? ? "Yes" : "No",
        workshop.effective_num_hours,
        workshop.enrollments.count,
        daily_scholarship_teacher_attendance(workshop),
        total_daily_attendance(workshop)
      ]
    end

  results
end

def attendance_urls(workshop)
  urls = []
  workshop.sessions.each do |session|
    urls << "https://studio.code.org/pd/workshop_dashboard/workshops/#{workshop.id}/attendance/#{session.id}"
  end
  urls.join("\n")
end

def daily_scholarship_teacher_attendance(workshop)
  num_teachers_all_sessions = []
  workshop.sessions.each_with_index do |session, i|
    num_teachers = 0
    attendances = session.attendances
    attendances.each do |attendance|
      if Pd::ScholarshipInfo.where(pd_enrollment_id: attendance.pd_enrollment_id)
        num_teachers += 1
      end
    end
    num_teachers_all_sessions << "Session #{i}: #{num_teachers}"
  end
  num_teachers_all_sessions.join("\n")
end

def total_daily_attendance(workshop)
  num_teachers_all_sessions = []
  workshop.sessions.each_with_index do |session, i|
    num_teachers_all_sessions << "Session #{i}: #{session.attendances.count}"
  end
  num_teachers_all_sessions.join("\n")
end

def main
  puts get_rows
  sheet = Google::Sheet.new CDO.csf_workshop_attendance_gsheet_key
  sheet.export(tab_name: 'CSF workshops', rows: get_rows)
end

main
