#!/usr/bin/env ruby
require_relative '../../lib/cdo/only_one'
exit unless only_one_running?(__FILE__)

require_relative '../../dashboard/config/environment'
require 'cdo/google_sheets_export'

#
# Uses a Google Cloud service account to write summer workshop data for this year into
# a spreadsheet in Google Drive (with permissions locked down to our organization) for exploration
# by our programs team.
#

subjects = [
  Pd::SharedWorkshopConstants::SUBJECT_SUMMER_WORKSHOP,
  Pd::SharedWorkshopConstants::SUBJECT_CSF_101,
  Pd::SharedWorkshopConstants::SUBJECT_CSF_201
]

EARLIEST_WORKSHOP_END_DATE = Date.new(2020, 6, 1)
LATEST_WORKSHOP_START_DATE = Date.new(2020, 8, 31)

workshops = []

# The first row is an array of strings, one for each attribute name.
workshops << Api::V1::Pd::WorkshopDownloadSerializer.new(Pd::Workshop.first).attributes.keys.map(&:to_s)

# Subsequent rows are for each workshop.
Pd::Workshop.where(subject: subjects).find_each do |w|
  if w.workshop_starting_date && w.workshop_starting_date >= Date.new(2020, 5, 15) && w.workshop_starting_date <= Date.new(2020, 8, 31)
    workshops << Api::V1::Pd::WorkshopDownloadSerializer.new(w).attributes.values
  end
end

# Seed results array with a header row
results = [%w(teacher_email teacher_name teacher_school workshop_id
                  workshop_start_date workshop_course regional_partner)]
workshop_ids_this_year = Pd::Workshop
  .scheduled_end_on_or_after(EARLIEST_WORKSHOP_END_DATE)
  .scheduled_start_on_or_before(LATEST_WORKSHOP_START_DATE)
  .pluck(:id)
enrollments_this_year = Pd::Enrollment.includes(:workshop).where(pd_workshop_id: workshop_ids_this_year)
enrollments_this_year.find_each do |enrollment|
  results << [
    enrollment.email,
    enrollment.first_name + ' ' + enrollment.last_name,
    enrollment.school,
    enrollment.workshop.id,
    enrollment.workshop_starting_date,
    enrollment.workshop.course,
    enrollment.workshop.regional_partner&.name
  ]
end

Google::Sheet.export(
  document_key: '1Ne5hAh7Xu32EVsvJ_B_JKcymTU67HmSVckAWDogb24c',
  sheet_name: 'enrollments',
  rows: results
)
