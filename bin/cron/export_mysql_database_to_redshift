#!/usr/bin/env ruby
require_relative '../../lib/cdo/only_one'
exit unless only_one_running?(__FILE__)

require_relative '../../dashboard/config/environment'
exit unless rack_env?(:production) && CDO.dashboard_hostname == 'studio.code.org'

require 'cdo/aws/dms'
require 'cdo/aws/rds'
require 'cdo/chat_client'
require 'cdo/redshift_import'

# Max time to wait for all tasks to complete import into staging tables.
TASK_EXECUTION_TIME = 16.hours
# Delay between each check on task status.
TASK_STATUS_DELAY = 10.minutes
# TODO: (suresh) Can this dynamically reference the endpoint defined the in the production data stack?
CLONE_CLUSTER_ID = 'production-clone-for-redshift-export-cluster'.freeze
CLONE_DB_INSTANCE_ID = 'db.r4.4xlarge'.freeze

def main
  ChatClient.message 'data', 'Beginning daily export from Aurora MySQL database to Redshift.'
  # Delete clone of production cluster if it was incorrectly left behind by a previous execution of the import process.
  Cdo::RDS.delete_cluster(CLONE_CLUSTER_ID)
  Cdo::RDS.clone_cluster(
    source_cluster_id: CDO.db_cluster_id,
    clone_cluster_id: CLONE_CLUSTER_ID,
    instance_type: CLONE_DB_INSTANCE_ID
  )

  # Get list of tasks that should be executed daily.
  daily_tasks = Cdo::DMS::ReplicationTask.tasks_by_frequency('daily')

  # Spawn one thread for each replication task, so we can start and monitor them independently.
  threads = []
  Thread.abort_on_exception = true
  daily_tasks.each do |task|
    # Wait 16 hours (make 96 attempts, once every 10 minutes) for tasks to complete successfully.
    # The user_levels task takes the longest (~10 hours).
    threads << Thread.new {task.start(TASK_EXECUTION_TIME.div(TASK_STATUS_DELAY), TASK_STATUS_DELAY)}
  end
  threads.each(&:join)

  # The DMS tasks exported to staging (_import_) tables to avoid disrupting queries on the production Redshift tables
  # during the lengthy table import process.  Rename the staging tables to the production table names to complete
  # the import process
  RedshiftImport.complete_table_import(Cdo::DMS.redshift_schemas_imported_from_database)

  ChatClient.message 'data', "Completed daily export from Aurora MySQL database to Redshift."
rescue StandardError => error
  ChatClient.message 'data', "Error during export from Aurora MySQL database to Redshift #{error.message}", color: 'red'
  raise error
ensure
  Cdo::RDS.delete_cluster(CLONE_CLUSTER_ID)
end

main
