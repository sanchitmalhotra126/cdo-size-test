#!/usr/bin/env ruby

require 'open-uri'
require 'json'
require File.expand_path('../../../pegasus/src/env', __FILE__)
require_relative '../../deployment'
require 'cdo/only_one'
require 'cdo/pager_duty'
require 'cdo/slack'

def main
  # Get the current developers room topic.
  current_topic = Slack.get_topic('developers')

  # Get the primary oncall from Pagerand secondary site on-calls from PagerDuty.
  primary_dotd_email = PagerDuty.on_call

  # Match PagerDuty email to Slack mention name.
  if primary_dotd_email
    users_list = open("https://slack.com/api/users.list?token=#{SLACK_TOKEN}").read
    primary_dotd_user = JSON.parse(users_list)['members'].
      find { |member| primary_dotd_email == member['profile']['email'] }['name']
  end
  primary_dotd_user = '(ERROR: check schedule)' unless primary_dotd_user

  # Set the new developers room topic
  new_topic = current_topic.sub(/^.+?;/, "DOTD: @#{primary_dotd_user};")
  Slack.update_topic('developers', new_topic)
end

main if only_one_running?(__FILE__)
