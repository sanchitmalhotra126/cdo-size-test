#!/usr/bin/env ruby

require 'cdo/chat_client'
require 'cdo/github'
require 'cdo/only_one'

# @return [Boolean] Whether  the topic of Slack#developers includes "DTT: yes".
def dtt_yes?
  current_topic = Slack.get_topic('developers')
  current_topic.include? 'DTT: yes'
end

# Updates the DTT portion of topic of Slack#developers to indicate robo-DTT.
def update_developers_topic_robo_dtt
  current_topic = Slack.get_topic('developers')
  raise unless current_topic.include? 'DTT: yes'
  new_topic = current_topic.gsub('DTT: yes', 'DTT: no (robo-DTT in progress)')
  Slack.update_topic(new_topic)
end

# Updates the DTT portion of topic of Slack#developers to indicate DTT yes.
def update_developers_topic_robo_failed
  current_topic = Slack.get_topic('developers')
  raise unless current_topic.include? 'DTT: no (robo-DTT in progress)'
  new_topic = current_topic.gsub('DTT: no (robo-DTT in progress)', 'DTT: robo-DTT failed')
  Slack.update_topic(new_topic)
end

def main
  unless dtt_yes?
    ChatClient.message(
      'infra-test',
      "robo-DTT skipped (\#developers topic is #{current_topic}).",
      color: 'yellow'
    )
  end
  update_developers_topic_robo_dtt

  pr_number = GitHub.create_pull_request(
    base: 'test',
    head: 'staging',
    title: 'DTT (Staging > Test) [robo-dtt]'
  )
  if pr_number.nil?
    ChatClient.message(
      'infra-test',
      'GitHub.create_pull request failed.',
      color: 'red'
    )
    update_developers_topic_robo_failed
    return
  end

  # TODO(asher): Add a reviewer (namely the next DOTD), add appropriate tags
  # (particularly deploy).

  merged = GitHub.merge_pull_request(pr_number)
  unless merged
    ChatClient.message(
      'infra-test',
      "GitHub.merge_pull_request(#{pr_number}) failed.",
      color: 'red'
    )
    update_developers_topic_robo_failed
    return
  end

  ChatClient.mesage(
    'infra-test',
    "robo-DTT (PR\##{pr_number})",
    color: 'green'
  )
rescue Exception => e
  ChatClient.message(
    'infra-test',
    "EXCEPTION: #{e.message}",
    color: 'red'
  )
  update_developers_topic_robo_failed
end

main if only_one_running?(__FILE__)
