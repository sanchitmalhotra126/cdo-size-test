#!/usr/bin/env ruby
#
# This script caches database queries whose results are displayed at studio.code.org/admin/progress.
#
require_relative('../../dashboard/config/environment')
require 'cdo/properties'

DASHBOARD_REPORTING_DB_READONLY = sequel_connect(
  CDO.dashboard_reporting_db_reader, CDO.dashboard_reporting_db_reader)

def main()
  return unless only_one_running?(__FILE__)

  SeamlessDatabasePool.use_persistent_read_connection do
    user_count = User.count

    levels_attempted = User.joins(:user_levels).group(:level_id).where('best_result > 0').count
    levels_passed = User.joins(:user_levels).group(:level_id).where('best_result >= 20').count

    Properties.set(:admin_progress, {
      user_count: user_count,
      levels_attempted: levels_attempted,
      levels_passed: levels_passed,
    })
  end 
end

main()
