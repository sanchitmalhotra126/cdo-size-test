  RedirectDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: Redirect www to root domain
        PriceClass: PriceClass_All
        Aliases:
          - www.<%= CDO.pegasus_hostname %>
        Origins:
          # An origin is required, but will never receive traffic
          - Id: PrimaryOrigin
            DomainName: <%= CDO.pegasus_hostname %>
            CustomOriginConfig:
              OriginProtocolPolicy: match-viewer
        DefaultCacheBehavior:
          TargetOriginId: PrimaryOrigin
          LambdaFunctionAssociations:
            # Trigging upon origin-request ensures redirect is cached
            - EventType: origin-request
              LambdaFunctionARN: !Ref WwwRedirectLambdaVersion1
          ForwardedValues:
            QueryString: "false"
            Headers:
              - Origin
            Cookies:
              Forward: none
          ViewerProtocolPolicy: allow-all
        ViewerCertificate:
          AcmCertificateArn: <%= certificate_arn %>
          SslSupportMethod: sni-only

  RedirectCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: RedirectCachePolicy
        ParametersInCacheKeyAndForwardedToOrigin: 
          CookiesConfig: 
            CookieBehavior: none
          HeadersConfig: 
            HeaderBehavior: whitelist
            Headers:
              - Origin
          QueryStringsConfig: 
            QueryStringBehavior: all

  WwwRedirectLambda:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: nodejs14.x
      Role: !GetAtt WwwRedirectLambdaRole.Arn
      Handler: index.handler
      Code:
        ZipFile: |
          'use strict';

          exports.handler = (event, context, callback) => {
            const request = event.Records[0].cf.request;
            const uri = request.uri;
            const host = request.headers.host[0].value;
            const querystring = request.querystring;

            // Start building new url
            let newUrl = 'https://<%= CDO.pegasus_hostname %>';

            // Append path
            if (uri) newUrl += uri;
            
            // Append query string
            if (querystring && querystring != '') newUrl += "?" + querystring;

            const response = {
              status: '302',
              statusDescription: '302 Redirect to root domain',
              headers: {
                location: [{
                  key: 'Location',
                  value: newUrl
                }]
              }
            };
            callback(null, response);
          };
      Description: Redirect www traffic to root domain
      TracingConfig:
        Mode: Active

  # To make a new version, bump the NAME of this resource and all references
  WwwRedirectLambdaVersion2:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref WwwRedirectLambda

  WwwRedirectLambdaRole:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "AllowLambdaServiceToAssumeRole"
            Effect: "Allow"
            Action:
              - "sts:AssumeRole"
            Principal:
              Service:
                - "lambda.amazonaws.com"
                - "edgelambda.amazonaws.com"
