<%# Note this file must be indented one level, as it is a child of 'Resources'. %>
  # -----------------------------------------------
  # Begin codeprojects.org resources
  # 
  # This template component includes resources for the codeprojects.org
  # infrastructure. Currently this is mostly manually deployed.
  # 
  # -----------------------------------------------

<%-
  domain = "codeprojects.org"
  hosted_zone = Aws::Route53::Client.new.list_hosted_zones_by_name(dns_name: domain).hosted_zones.first
  raise "Could not find #{domain} in hosted zones" unless hosted_zone.name.delete_suffix('.') == domain
  hosted_zone_id = hosted_zone.id.delete_prefix("/hostedzone/")

  envs = {
    staging: {
      domain_name: "staging.codeprojects.org",
      alternative_names: []
    },
    # test: {
    #   domain_name: "test.codeprojects.org",
    #   alternative_names: []
    # },
    # production: {
    #   domain_name: "codeprojects.org",
    #   alternative_names: ["www.codeprojects.org"]
    # },
  }
-%>

<%- if rack_env?(:staging) -%>
  # Developer Resources (Deployed with Staging)
  LocalhostCodeprojectsRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: codeprojects.org
      Name: localhost.codeprojects.org
      Type: A
      TTL: 3600
      ResourceRecords:
        - 127.0.0.1
<%- end -%>

<%- envs.each do |env, config| -%>
<%- if rack_env == env -%>

  # <%= env %> Resources
  Codeprojects<%= env.capitalize %>Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: <%= config[:domain_name] %>
      <%- unless config[:alternative_names].empty? -%>
      SubjectAlternativeNames:
        <%- config[:alternative_names].each do | alt_name | -%>
        - <%= alt_name %>
        <%- end -%>
      <%- end -%>
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: <%= config[:domain_name] %>
          HostedZoneId: <%= hosted_zone_id %>
        <%- config[:alternative_names].each do | alt_name | -%>
        - DomainName: <%= alt_name %>
          HostedZoneId: <%= hosted_zone_id %>
        <%- end -%>
<%- end -%>
<%- end -%>

  # -----------------------------------------------
  # End codeprojects.org resources
  # -----------------------------------------------
