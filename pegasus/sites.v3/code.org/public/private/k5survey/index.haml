:ruby
  surveys = DB[:forms].where(kind:'K5ProfessionalDevelopmentSurvey')

  def fetch_workshop_info(workshop_id)
    workshop = DB[:forms].where(id:workshop_id.to_i).first
    return {} unless workshop
    JSON.parse(workshop[:data]).merge(JSON.parse(workshop[:processed_data])).merge({'user_id'=>workshop[:user_id]})
  end

  def satisfaction_s_to_i(value)
    case value
    when 'extremely satisfied (would recommend to others)'
      return 5
    when 'moderately satisfied'
      return 4
    when 'neither satisfied nor dissatisfied'
      return 3
    when 'moderately dissatisfied'
      return 2
    when 'dissatisfied (would not recommend to others)'
      return 1
    end
  end

  def generate_professional_development_workshop_teachers_report
    # generate a report about the teachers trained by affiliates and their students' progress
    PEGASUS_DB[:forms].where(kind: 'ProfessionalDevelopmentWorkshop').map do |affiliate|
      data = JSON.parse(affiliate[:data]) rescue {}

      section_id = data['section_id_s']
      next unless section_id

      # a row for each teacher trained by an affiliate
      DASHBOARD_DB[:followers].
        where(section_id: section_id).
        join(:users, id: :student_user_id).
        select(:users__id___id, :users__name___name, :users__email___email).map do |teacher|

        # get data on students of the teacher
        teacher_user_id = teacher[:id]
        next unless teacher_user_id

        students = DASHBOARD_DB[:followers].
          where(user_id: teacher_user_id).
          join(:users, id: :student_user_id).
          select(:users__id___id, :users__created_at___created_at)

        if students.count > 0
          lifetime = students.map{|s| (Time.now - s[:created_at]) / (60 * 60 * 24)}.reduce(:+) / students.count.to_f

          levels = students.map do |s|
            DASHBOARD_DB[:user_levels].
            where(user_id: s[:id]).
            and("best_result >= #{ActivityConstants::MINIMUM_PASS_RESULT}").
            count
          end.reduce(:+) / students.count.to_f
        else
          lifetime = 0
          levels = 0
        end

        {
          teacher_name: teacher[:name],
          teacher_email: teacher[:email],
          affiliate_name: affiliate[:name],
          affiliate_email: affiliate[:user_id],
          students_count: students.count,
          students_average_lifetime_days: lifetime.round,
          students_average_levels_completed: levels.round(2)
        }
      end.compact
    end.compact.flatten
  end
%link(rel='stylesheet' type='text/css' href='/css/learn_tabs.css')
%h1
  K5 Survey Statistics
#learn-tabs{style: "padding-top:20px; padding-left:20px; padding-right:20px; background-color:white; background-color: rgb(219, 219, 219); overflow: hidden; margin-bottom: 10px;"}
  %ul.nav.nav-tabs{style: "float: left;"}
    %li.active.tab
      %a{href:"/"} Results
    %li
      %a{href:"k5survey/raw2"} Raw2

%h2
  Results
%table
  %tr
    %th
      email_s
    %th
      facilitator_prepared_i
    %th
      facilitator_knowledgeable_i
    %th
      facilitator_enjoyable_i
    %th
      facilitator_professional_i
    %th
      workshop_start_i
    %th
      workshop_end_i
    %th
      workshop_materials_i
    %th
      workshop_venue_i
    %th
      workshop_food_i
    %th
      satisfaction_s

  - surveys.each do |row|
    - data = JSON.parse(row[:data]).merge(JSON.parse(row[:processed_data]))
    - workshop = fetch_workshop_info data['workshop_id_i']
    - data['workshop_stopped_dt'] = workshop['stopped_dt']
    - data['workshop_facilitator_email'] = workshop['user_id']
    - data['workshop_facilitator_name'] = workshop['name_s']
    - data['satisfaction_s'] = satisfaction_s_to_i(data['satisfaction_s'])
    %tr
      %td
        #{data['email_s']}
      %td
        #{data['facilitator_prepared_i']}
      %td
        #{data['facilitator_knowledgeable_i']}
      %td
        #{data['facilitator_enjoyable_i']}
      %td
        #{data['facilitator_professional_i']}
      %td
        #{data['workshop_start_i']}
      %td
        #{data['workshop_end_i']}
      %td
        #{data['workshop_materials_i']}
      %td
        #{data['workshop_venue_i']}
      %td
        #{data['workshop_food_i']}
      %td
        #{data['satisfaction_s']}