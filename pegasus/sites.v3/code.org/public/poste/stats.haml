---
title: Poste Stats
---

- if params[:name].blank?
  %h2
    Please select a message from
    %a{href: 'list'} this list
- else
  :ruby
    rows = DB.fetch("
      SELECT
        poste_messages.name AS message,
        COUNT(poste_deliveries.id) AS deliveries,
        COUNT(poste_deliveries.sent_at) AS sent,
        COUNT(DISTINCT poste_opens.id) as opens,
        (COUNT(DISTINCT poste_opens.id) * 100) / COUNT(poste_deliveries.sent_at) AS percent_opened,
        COUNT(poste_clicks.id) as clicks,
        (COUNT(poste_clicks.id) * 100) / COUNT(DISTINCT poste_opens.id) AS percent_clicked,
        (COUNT(poste_clicks.id) * 100) / COUNT(poste_deliveries.sent_at) AS percent_clicked_sent
      FROM poste_messages
      LEFT JOIN poste_deliveries ON poste_deliveries.message_id = poste_messages.id
      LEFT JOIN poste_opens ON poste_opens.delivery_id = poste_deliveries.id
      LEFT JOIN poste_clicks ON poste_clicks.delivery_id = poste_deliveries.id
      WHERE poste_messages.name = '#{params[:name]}'
    ")

  %table
    %tr
      %th Message
      %th Members
      %th Sent
      %th Opens
      %th Clicks
    - rows.each do |row|
      %tr
        %td
          %a{:href => "##{row[:message]}"}= row[:message]
          %a{:name => row[:message]}
        %td= row[:deliveries]
        %td= row[:sent]
        %td
          = row[:opens]
          %br/
          = row[:percent_opened].to_i
          \% sent
        %td
          = row[:clicks]
          %br/
          = row[:percent_clicked].to_i
          \% opened
          %br/
          = row[:percent_clicked_sent].to_i
          \% sent
