#!/usr/bin/env ruby
require_relative '../../../src/env'
require 'cdo/solr'
require 'cdo/only_one'
require 'cdo/hip_chat'
require src_dir 'database'

SOLR = Solr::Server.new(host:CDO.solr_server)

UNSUBSCRIBERS = DB[:contacts].where('unsubscribed_at IS NOT NULL').map(:email).map{|i|i.downcase}

def main()
  DB[:cdo_mailing_lists].all do |i|
    count = 0

    CSV.open(pegasus_dir('sites.v3', 'code.org', 'public', 'private', "#{i[:name_s]}.csv"), 'wb') do |csv|
      SOLR.query(q:i[:query_t], rows:10000).each do |i|
        name = i['name_s'].to_s.strip
        email = i['email_s'].strip.downcase
        unless UNSUBSCRIBERS.include?(email)
          csv << [name, email]
          count += 1
        end
      end
    end

    HipChat.log "<b>#{i[:name_s]}</b> mailing list created, <b>#{count}</b> recipients."
  end
end

main() if only_one_running?(__FILE__)
