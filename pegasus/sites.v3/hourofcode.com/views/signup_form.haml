- require 'country_codes'
-# %script{src: minifiable_asset_path('js/schoolInfo.js')}
- signup_submit_error_message = hoc_s(:signup_submit_error_message).gsub(/"/,"\\\\\"")
- hoc_year = DCDO.get("hoc_year", 2017)

#signupform
  %h2= hoc_s(:signup_header).gsub(/%{campaign_date}/, campaign_date("full"))
  %form{:id=>"hoc-signup-form", role: "form", onsubmit: "event.preventDefault();"}
    #error_message

    .main-form
      .form-group
        %label.control-label{for: "hoc-name"}
          = hoc_s(:signup_name_label)
          %span.required*
        %div
          %input#hoc-name.form-control{name: "name_s", placeholder: hoc_s(:signup_name_placeholder), type: "text"}
        #name-error.error-message{style: "display:none;"}
          = hoc_s(:signup_name_error)

      .form-group
        %label.control-label{for: "hoc-email"}
          = hoc_s(:signup_email_label)
          %span.required*
        %div
          %input#hoc-email.form-control{name: "email_s", placeholder: hoc_s(:signup_email_placeholder), type: "text"}
        #email-error.error-message{style: "display:none;"}
          =hoc_s(:signup_email_error)

      .form-group
        %label.control-label{for: "hoc-event-country"}
          = hoc_s(:signup_event_country_label)
          %span.required*
        %select#country.form-control{name: "hoc_country_s", type: "select"}
          %option{value: "", selected: true, disabled: true}
          - COUNTRY_CODE_TO_COUNTRY_NAME.keys.each do |code|
            %option{value: code}= country_name_from_code(code)
        #country-error.error-message{style: "display:none;"}
          =hoc_s(:signup_event_country_error)

      .form-group
        %label.control-label{for: "hoc-event-type"}
          = hoc_s(:signup_event_type_label)
          %span.required*
        %div
          %select#hoc-event-type.form-control{name: "event_type_s", type: "select"}
            %option{value: nil, selected: true}
            -['in_school', 'out_of_school'].each do |event_type|
              %option{value: event_type}= hoc_s('signup_event_type_' + event_type)
        #event-type-error.error-message{style: "display:none;"}
          =hoc_s(:signup_event_type_error)

      -# School lookup autocomplete will go here.
      -# Until it's ready, default to school name and event location

      .form-group#school-name-field{style: "display: none;"}
        %label.control-label{for: "school-name"}
          = hoc_s(:school_name)
          %span.required*
        %div
          %input#school-name.form-control{name: "school_name_s", type: "text"}
        #school-name-error.error-message{style: "display:none;"}
          School name is required.

      .form-group#organization-name-field{style: "display: none;"}
        %label.control-label{for: "hoc-organization-name"}
          = hoc_s(:signup_organization_name_label)
        %div
          %input#organization-name.form-control{name: "organization_name_s", type: "text"}

      .form-group#hoc-event-location-field{style: "display: none;"}
        %label.control-label{for: "hoc-event-location"}
          = hoc_s(:signup_event_location_label)
          %span.required*
        %div
          %textarea#hoc-event-location.form-control{name: "event_location_s", placeholder: "Event location address", style: "height: 4em;"}
        #event-location-error.error-message{style: "display:none;"}
          Event location is required.

      .form-group#hoc-entire-school{style: "display: none;"}
        .checkbox
          %label
            %input#hoc-entire-school-flag{name: "entire_school_flag_b", type: "checkbox", value: "1"}/
            =hoc_s(:signup_event_entire_school_label)

      .form-group
        .checkbox
          %label
            %input#hoc-special-event-flag{name: "special_event_flag_b", type: "checkbox", value: "1"}/
            =hoc_s(:signup_special_event_flag_label)

      .form-group{style: "display: none;"}
        %label.control-label{for: "hoc-special-event-details"}
          = hoc_s(:signup_special_event_details_label)
        %div
          %textarea#hoc-special-event-details.form-control{name: "special_event_details_s", placeholder: hoc_s(:signup_special_event_details_placeholder), style: "height: 5em;"}

      .form-group
        .checkbox
          %label
            %input#hoc-match-volunteer-flag{name: "match_volunteer_flag_b", type: "checkbox", value: "1"}/
            =hoc_s(:signup_match_volunteer)

    .form-group.continue-btn{style: "display: none;"}
      %div
        %button.continue-btn{type: "button"}
          =hoc_s(:signup_continue_label)

    #census-questions{style: "display: none;"}
      =view :census_questions

    #submit
      %input{name:'hoc_country_s', type:'hidden', value:@country}
      %input{name:'hoc_company_s', type:'hidden', value:@company}
      %p.footnote
        = hoc_s(:signup_multiple_event_warning)
        %strong= hoc_s(:signup_registration_deadline)
      .form-group.submit-btn
        %div
          %button{type: "submit"}= hoc_s(:signup_submit_label)

:javascript
  $(document).ready(function() {
    new google.maps.places.SearchBox(document.getElementById('hoc-event-location'));

    $('#hoc-signup-form select').selectize({
      plugins: ['fast_click']
    });

    $( "#hoc-signup-form" ).submit(function( event ) {
      if (validateFields()) {
        signupFormSubmit();
      }
    });

    $('.continue-btn').click(function() {
      if (validateFields()) {
        $('.main-form').hide();
        $('.continue-btn').hide();
        $('#census-questions').show();
        $('#submit').show();
      }
    });

    $('#hoc-special-event-flag').change(function() {
      if($(this).is(':checked')) {
        $('#hoc-special-event-details').closest('.form-group').slideDown();
      } else {
        $('#hoc-special-event-details').closest('.form-group').slideUp();
      }
    });

    $('#hoc-event-type').change(function() {
      // in-school & US
      if(($(this).val() == 'in_school') && ($("#country").val() == 'US')) {
        $('#school-name-field').show();
        $('#organization-name-field').hide();
        $('#hoc-event-location-field').show();
        $('#hoc-entire-school').show();
        // continue button goes to census questions on click
        $('.continue-btn').show();
        $('#submit').hide();
      } else if (($(this).val() == 'in_school')){
      // in-school & NOT US
        $('#school-name-field').show();
        $('#organization-name-field').hide();
        $('#hoc-event-location-field').show();
        $('#hoc-entire-school').show();
        $('.continue-btn').hide();
        $('#submit').show();
      } else if ($(this).val() == 'out_of_school') {
        // out of school, either US or non-US
        $('#organization-name-field').show();
        $('#hoc-event-location-field').show();
        $('#school-name-field').hide();
        $('#hoc-entire-school').hide();
        $('.continue-btn').hide();
        $('#submit').show();
      }
    });

    $('#country').change(function() {
      // US & in school
      if(($(this).val() == 'US') && ($("#hoc-event-type").val() == 'in_school')) {
        $('#school-name-field').show();
        $('#organization-name-field').hide();
        $('#hoc-event-location-field').show();
        $('#hoc-entire-school').show();
        // continue button goes to census questions on click
        $('.continue-btn').show();
        $('#submit').hide();
      } else if (!($(this).val() == 'US') && ($("#hoc-event-type").val() == 'in_school')){
      // non-US & in school
        $('#school-name-field').show();
        $('#organization-name-field').hide();
        $('#hoc-event-location-field').show();
        $('#hoc-entire-school').show();
        $('.continue-btn').hide();
        $('#submit').show();
      } else if ($("#hoc-event-type").val() == 'out_of_school'){
        // out of school
        $('#organization-name-field').show();
        $('#hoc-event-location-field').show();
        $('#school-name-field').hide();
        $('#hoc-entire-school-field').hide();
        $('.continue-btn').hide();
        $('#submit').show();
      }
    });

    function checkShowFollowUp() {
      if($("#twenty-hour-how-much").val() == "some" || $("#twenty-hour-how-much").val() == "all" || $("#ten-hour-how-much").val() == "some" ||
      $("#ten-hour-how-much").val() == "all") {
        $('#followup_questions').show();
      } else {
        $('#followup_questions').hide();
      }
    }

    $('#twenty-hour-how-much').change(function() {
      checkShowFollowUp();
    })

    $('#ten-hour-how-much').change(function() {
      checkShowFollowUp();
    })

    $('#role').change(function() {
      if($(this).val() == "teacher" || $(this).val() == "administrator") {
        $('#pledge').show();
      } else {
        $('#pledge').hide();
      }
    })
   });

  function signupFormComplete(data)
  {
    window.location = "#{resolve_url('thanks')}";
  }

  function validateFields()
  {
    if ($("#hoc-name").val() == "") {
      $('#name-error').show();
      return false
    } else {
      $('#name-error').hide();
    }

    if ($("#hoc-email").val() == "") {
      $('#email-error').show();
      return false
    } else {
      $('#email-error').hide();
    }

    if ($("#country").val() == "") {
      $('#country-error').show();
      return false
    } else {
      $('#country-error').hide();
    }

    if ($("#hoc-event-type").val() == "") {
      $('#event-type-error').show();
      return false
    } else {
      $('#event-type-error').hide();
    }

    if  ($("#hoc-event-type").val() == "in_school" && $("#country").val() == "US") {
      console.log("SCHOOL NAME:", $("#school-name").val())
      if ($("#school-name").val() == "") {
        $('#school-name-error').show();
        return false
      } else {
        $('#school-name-error').hide();
      }
    }

    if  ($("#hoc-event-type").val() == "in_school" && $("#country").val() == "US") {
      if ($("#hoc-event-location").val() == "") {
        $('#event-location-error').show();
        return false
      } else {
        $('#event-location-error').hide();
      }
    }
    return true
  }

  function signupFormError(data)
  {
    $('#error_message').html("<p>#{signup_submit_error_message}</p>").show();
    $("#signup_submit").removeAttr('disabled');
  }

  function signupFormSubmit()
  {
    $("#signup_submit").attr('disabled','disabled');

    $.ajax({
      url: "/forms/HocSignup#{hoc_year}",
      type: "post",
      dataType: "json",
      data: $("#hoc-signup-form").serialize()
    }).done(signupFormComplete).fail(signupFormError);

    return false;
  }
