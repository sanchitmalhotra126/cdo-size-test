var message1 = "Srryvat zl jnl guebhtu gur qnexarff Thvqrq ol n orngvat urneg V pna g gryy jurer gur wbhearl jvyy raq Ohg V xabj jurer gb fgneg Gurl gryy zr V z gbb lbhat gb haqrefgnaq Gurl fnl V z pnhtug hc va n qernz Jryy yvsr jvyy cnff zr ol vs V qba g bcra hc zl rlrf Jryy gung f svar ol zr Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg V gevrq pneelvat gur jrvtug bs gur jbeyq Ohg V bayl unir gjb unaqf Ubcr V trg gur punapr gb geniry gur jbeyq Ohg V qba g unir nal cynaf Jvfu gung V pbhyq fgnl sberire guvf lbhat Abg nsenvq gb pybfr zl rlrf Yvsr f n tnzr znqr sbe rirelbar Naq ybir vf gur cevmr Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg";
var message2 = "Ej aeotj pbba zdlxu ftlj E a lqkvj jk plu Pvrpterb ptb p tbdb ukv zlr jlhb lflu E a l tkj led qlcckkr E zkvcn ok jk pmlzb Fejt jtb led cehb E nkr j zldb qlqu qu jtb flu Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Tbdb zkab qln rbfp jlchero jtep lrn jtlj Ublt oewb ab lcc ukv okj nkr j tkcn qlzh Ublt fbcc E ptkvcn mdkqlqcu fldr ukv E cc qb svpj yerb Ublt rk kyybrpb jk ukv nkr j flpjb ukvd jeab Tbdb p ftu Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Tlmmu qdero ab nkfr Zlr j rkjtero qdero ab nkfr Ckwb ep jkk tlmmu jk qdero ab nkfr Zlr j rkjtero qdero ab nkfr E plen qdero ab nkfr Zlr j rkjtero qdero ab nkfr Ckwb ep jkk tlmmu jk qdero ab nkfr Zlr j rkjtero qdero ab nkfr E plen Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Tlmmu qdero ab nkfr Zlr j rkjtero qdero ab nkfr Ckwb ep jkk tlmmu jk qdero ab nkfr Zlr j rkjtero qdero ab nkfr E plen Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk";
var SUBST_MAP = {};
var bg;

var ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
var LETTERS = ALPHABET.split('');
var ENGLISH = {
  A: 0.08167,
  B: 0.01492,
  C: 0.02782,
  D: 0.04253,
  E: 0.01.702,
  F: 0.02228,
  G: 0.02015,
  H: 0.06094,
  I: 0.06966,
  J: 0.00153,
  K: 0.00772,
  L: 0.04025,
  M: 0.02406,
  N: 0.06749,
  O: 0.07507,
  P: 0.01929,
  Q: 0.00095,
  R: 0.05987,
  S: 0.06327,
  T: 0.09056,
  U: 0.02758,
  V: 0.00978,
  W: 0.02361,
  X: 0.0015,
  Y: 0.01974,
  Z: 0.00074
};

var buildFrequencyMap = function () {
  var inputString = $("#input").val().replace(/[^A-Za-z]/g, "").toUpperCase();
  var totalCharCount = inputString.length;

  // Create a zeroed-out frequency map.
  var freqMap = LETTERS.reduce(function (frequencies, letter) {
    frequencies[letter] = 0;
    return frequencies;
  }, {});

  // If the input is empty, return all zeroes early so we can save work
  // and avoid trying to divide by zero later on.
  if (totalCharCount === 0) {
    return freqMap;
  }

  // Count all the letters
  var countMap = inputString.split('').reduce(function (counts, letter) {
    counts[letter] = counts[letter] ? counts[letter] + 1 : 1;
    return counts;
  }, {});

  // frequency = count/total for each letter;
  Object.keys(countMap).forEach(function (letter) {
    freqMap[letter] = countMap[letter] / totalCharCount;
  });

  return freqMap;
}

var processPlainText = function () {
  var freqMap = buildFrequencyMap();
  bg.updateUserData(freqMap);
  processSubstitutions();
}

var processSubstitutions = function () {
  var STR = $("#input").val().replace(/[^A-Za-z]/g, " ");

  LETTERS.forEach(function (letter) {
    if (SUBST_MAP[letter]) {
      STR = STR.replace(new RegExp(letter + "(?!" + letter + "*</>)", "g"), "<>" + SUBST_MAP[letter] + "</>");
      STR = STR.replace(new RegExp(letter.toLowerCase() + "(?!</>)", "g"), "<>" + SUBST_MAP[letter].toLowerCase() + "</>");
    }
  });

  if (bg) {
    //bg.updateSubstMap(SUBST_MAP);
  }

  STR = STR.replace(/<>/g, "<mark>");
  STR = STR.replace(/<\/>/g, "</mark>");
  $("#output").html(STR);
}

var shiftSubstitution = function (shiftAmt) {

  shiftAmt = shiftAmt % 26; //just in case;
  $("#shiftSliderDisplay").html(shiftAmt);
  if (shiftAmt < 0) shiftAmt = 26 + shiftAmt;

  var substMap = {};
  LETTERS.forEach(function (letter, i) {
    substMap[letter] = LETTERS[(i + shiftAmt) % 26];
  });

  processSubstitutions();
  SUBST_MAP = substMap;
  return substMap;

}

var fillRandom = function () {
  LETTERS.forEach(function (letter) {
    var rand = Math.floor(Math.random() * LETTERS.length);
    SUBST_MAP[letter] = LETTERS[rand];
  });

  processSubstitutions();
}

var clearSubstitutions = function () {
  shiftSubstitution(0);
  processSubstitutions();
}

var BarGraph = function (substMap) {
  this.margin = {
    top: 30,
    right: 20,
    bottom: 60,
    left: 40
  };

  this.user_data = LETTERS.map(function (letter) {
    return {
      letter: letter,
      frequency: 0
    };
  });

  this.english_data = LETTERS.map(function (letter) {
    return {
      letter: substMap[letter],
      frequency: ENGLISH[letter]
    };
  });

};

BarGraph.prototype.updateSubstMap = function (substMap) {
  this.english_data = this.user_data.map(function (d) {
    return {
      letter: substMap[d.letter],
      frequency: ENGLISH[substMap[d.letter]]
    };
  });
  this.render();
};

BarGraph.prototype.updateUserData = function (frequencies) {
  this.user_data.forEach(function (d) {
    d.frequency = frequencies[d.letter];
  });
  this.render();
};

BarGraph.prototype.getHeight = function () {
  return this.container.property("offsetHeight") - this.margin.top - this.margin.bottom;
};
BarGraph.prototype.getWidth = function () {
  return this.container.property("offsetWidth") - this.margin.left - this.margin.right;
};

BarGraph.prototype.reorder = function () {

  /* reorder the domains */
  this.userLetterScale.domain(this.user_data.map(function (d) {
    return d.letter;
  }));
  this.englishLetterScale.domain(this.english_data.map(function (d) {
    return d.letter;
  }));

  /* animate rearranging the elements */
  var transition = this.svg.transition().duration(750);

  transition.selectAll(".letter")
    .attr("transform", function (d) {
      return "translate(" + this.userLetterScale(d.user.letter) + "," + this.getHeight() + ") scale(1, -1)";
    }.bind(this));

  transition.selectAll(".dragletter")
    .attr("transform", function (d) {
      return "translate(" + this.userLetterScale(d.user.letter) + ",0)";
    }.bind(this));

  transition.select(".x.axis")
    .call(this.xAxis);

  transition.each("end", function () {

    /* resort the elements in the DOM */
    this.svg.selectAll(".letter")
      .sort(function (a, b) {
        return this.englishLetterScale(a.english.letter) - this.englishLetterScale(b.english.letter);
      }.bind(this));

    this.svg.selectAll(".dragletter")
      .sort(function (a, b) {
        return this.userLetterScale(a.user.letter) - this.userLetterScale(b.user.letter);
      }.bind(this));

    /* note: no need to manually resort .x.axis, as the xAxis call does
     * that for us
     */

    /* the call to drag uses the ordering. so reattach that here */
    this.svg.select('.x1.axis').selectAll('.dragletter').call(this.drag);

    /* rerender just because */
    this.render();

  }.bind(this));

};

BarGraph.prototype.getZippedData = function (override) {
  var user_data = override || this.user_data;
  return user_data.map(function (_, i) {
    return {
      user: user_data[i],
      english: this.english_data[i]
    };
  }, this);
};

BarGraph.prototype.handleSortChange = function (changeEvent) {
  var sortFun;
  var sortType = changeEvent.target.value;

  if (sortType === "alphabetic") {
    sortFun = function (a, b) {
      return (a.letter.charCodeAt() - b.letter.charCodeAt());
    };
  } else if (sortType === "frequency") {
    sortFun = function (a, b) {
      // we do b-a rather than a-b because the values we're examining
      // are < 1
      return (b.frequency - a.frequency);
    };
  } else {
    return;
  }

  // cache the english -> user mapping
  var substMap = this.english_data.reduce(function (map, d, i) {
    map[d.letter] = this.user_data[i];
    return map;
  }.bind(this), {});

  // reorder the english data
  this.english_data = this.english_data.sort(sortFun);

  // reorder users based on the preserved mapping
  this.user_data = this.english_data.map(function (d) {
    return substMap[d.letter];
  });

  this.reorder();
};


BarGraph.prototype.init = function () {
  this.container = d3.select("#d3chart");

  // We use two scales because we have two domain orderings
  var letterScale = d3.scale.ordinal().rangeRoundBands([0, this.getWidth()], 0.2);
  this.userLetterScale = letterScale.copy().domain(LETTERS);
  this.englishLetterScale = letterScale.copy().domain(LETTERS);

  this.freqScale = d3.scale.ordinal().domain([0, 1]);

  this.yScale = d3.scale.linear().range([this.getHeight(), 0]);

  this.xAxis = d3.svg.axis()
    .scale(this.englishLetterScale)
    .orient("bottom");

  this.yAxis = d3.svg.axis()
    .scale(this.yScale)
    .orient("left")
    .ticks(5, "%");

  this.svg = this.container.append("svg")
    .attr({
      "width": this.getWidth() + this.margin.left + this.margin.right,
      "height": this.getHeight() + this.margin.top + this.margin.bottom
    })
    .append("g")
    .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");

  this.freqScale.rangeRoundBands([0, this.userLetterScale.rangeBand()]);

  this.svg.append("g")
    .attr({
      "class": "x axis",
      "transform": "translate(0," + this.getHeight() + ")"
    })
    .call(this.xAxis)
    .selectAll("text")
    .attr({
      "class": "english",
      "y": 28 // this isn't doing anything?
    });

  var userLetters = this.svg.append("g")
    .attr({
      "class": "x1 axis",
      "transform": "translate(" + this.userLetterScale.rangeBand() / 2 + "," + (10 + this.getHeight()) + ")"
    })
    .selectAll('g')
    .data(this.getZippedData())
    .enter().append('g')
    .attr("class", "dragletter");

  userLetters.append("rect")
    .attr({
      "height": 18,
      "width": this.userLetterScale.rangeBand(),
      "x": -(this.userLetterScale.rangeBand() / 2),
      "y": 8
    });

  [-3, 0, 3].forEach(function (offset) {
    userLetters.append("line")
      .attr({
        "x1": offset,
        "x2": offset,
        "y1": 20,
        "y2": 25
      });
  });

  userLetters.append("text")
    .attr("dy", ".71em")
    .attr("y", 10)
    .attr("class", "user")
    .style("text-anchor", "middle")
    .text(function (d, i) {
      return d.user.letter;
    });

  $(".btn-group button").on("change input click", this.handleSortChange.bind(this));

  this.svg.append("g")
    .attr("class", "y axis")
    .call(this.yAxis)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
    .text("Frequency");

  this.svg.selectAll(".letter")
    .data(this.getZippedData())
    .enter().append("g")
    .attr("class", "letter")
    .attr("transform", function (d) {
      return "translate(" + this.userLetterScale(d.user.letter) + "," + this.getHeight() + ") scale(1, -1)";
    }.bind(this));

  this.svg.selectAll('.letter').selectAll("rect")
    .data(function (d) {
      return [d.english, d.user];
    })
    .enter().append("rect")
    .attr("class", function (d, i) {
      return (i === 0) ? "english" : "user";
    })
    .attr("width", this.freqScale.rangeBand())
    .attr("x", function (d, i) {
      return this.freqScale(i);
    }.bind(this));

  var drag = this.drag = d3.behavior.drag();

  var tempdata;

  drag.on('dragend', function () {
    this.user_data = tempdata;
    this.reorder();
  }.bind(this));

  drag.on('drag', function (d, i) {

    /* move the source */
    var source = this.svg.select("#userletter-" + d.user.letter);
    var coords = source.attr("transform").replace(/[A-Za-z()]/g, '').split(',');
    source.attr("transform", "translate(" + (parseInt(coords[0]) + d3.event.dx) + "," + (parseInt(coords[1]) + d3.event.dy) + ")");

    /* find the target */
    var xPos = d3.event.x;
    var leftEdges = this.userLetterScale.range();
    var width = this.userLetterScale.rangeBand();
    var j;

    for (j = 0; xPos > (leftEdges[j] + width); j++) {}

    /* swap em! */
    tempdata = this.user_data.map(function (d) {
      return jQuery.extend(true, {}, d);
    });

    console.log("swapping " + tempdata[i].letter + "(" + i + ") with " + tempdata[j].letter + "(" + j + ")");

    var swap = tempdata[i];
    tempdata[i] = tempdata[j];
    tempdata[j] = swap;

    this.svg.selectAll('.letter').data(this.getZippedData(tempdata));

    this.svg.selectAll('.letter').selectAll("rect")
      .data(function (d) {
        return [d.english, d.user];
      })
      .attr("height", function (d) {
        return this.getHeight() - this.yScale(d.frequency);
      }.bind(this));

  }.bind(this));

  this.svg.select('.x1.axis').selectAll('.dragletter').call(drag);

};

BarGraph.prototype.render = function () {
  if (!this.svg || !this.user_data || !this.english_data) {
    return false;
  }

  var data = this.getZippedData();

  this.yScale.domain([0, d3.max(data, function (d) {
    var maxValue = Math.max(d.english.frequency, d.user.frequency);

    // Round to the nearest 10% ?
    //return Math.ceil(maxValue*10)/10;
    //
    return maxValue;
  })]);

  this.svg.select(".y.axis")
    .call(this.yAxis);

  this.svg.select(".x.axis")
    .call(this.xAxis);

  this.svg.select(".x1.axis")
    .data(data)
    .selectAll(".dragletter")
    .attr("id", function (d, i) {
      return "userletter-" + d.user.letter;
    })
    .attr("transform", function (d, i) {
      return "translate(" + this.userLetterScale(d.user.letter) + ",0)";
    }.bind(this))
    .sort(function (a, b) {
      return this.userLetterScale(a.user.letter) - this.userLetterScale(b.user.letter);
    }.bind(this));

  this.svg.selectAll('.letter').data(data);

  this.svg.selectAll('.letter').selectAll("rect")
    .data(function (d) {
      return [d.english, d.user];
    })
    .attr("height", function (d) {
      return this.getHeight() - this.yScale(d.frequency);
    }.bind(this));

  return true;
};

$(document).ready(function () {
  var substMap = shiftSubstitution(0);
  bg = new BarGraph(substMap);
  bg.init();
  bg.render();

  $("#input").on("input", processPlainText);

  $(".load-message#easy").click(function () {
    $('#input').val(message1).trigger('input');
  });

  $(".load-message#hard").click(function () {
    $('#input').val(message2).trigger('input');
  });

  $("#fillRand").click(fillRandom);
  $("#clear").click(clearSubstitutions);

  processPlainText();
  $("input").keyup(processSubstitutions);
  $(".btn-group button").button();
});
