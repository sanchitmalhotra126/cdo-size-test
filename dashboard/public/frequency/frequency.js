var message1 = "Srryvat zl jnl guebhtu gur qnexarff Thvqrq ol n orngvat urneg V pna g gryy jurer gur wbhearl jvyy raq Ohg V xabj jurer gb fgneg Gurl gryy zr V z gbb lbhat gb haqrefgnaq Gurl fnl V z pnhtug hc va n qernz Jryy yvsr jvyy cnff zr ol vs V qba g bcra hc zl rlrf Jryy gung f svar ol zr Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg V gevrq pneelvat gur jrvtug bs gur jbeyq Ohg V bayl unir gjb unaqf Ubcr V trg gur punapr gb geniry gur jbeyq Ohg V qba g unir nal cynaf Jvfu gung V pbhyq fgnl sberire guvf lbhat Abg nsenvq gb pybfr zl rlrf Yvsr f n tnzr znqr sbe rirelbar Naq ybir vf gur cevmr Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg V qvqa g xabj V jnf ybfg Fb jnxr zr hc jura vg f nyy bire Jura V z jvfre naq V z byqre Nyy guvf gvzr V jnf svaqvat zlfrys Naq V qvqa g xabj V jnf ybfg";
var message2 = "Ej aeotj pbba zdlxu ftlj E a lqkvj jk plu Pvrpterb ptb p tbdb ukv zlr jlhb lflu E a l tkj led qlcckkr E zkvcn ok jk pmlzb Fejt jtb led cehb E nkr j zldb qlqu qu jtb flu Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Tbdb zkab qln rbfp jlchero jtep lrn jtlj Ublt oewb ab lcc ukv okj nkr j tkcn qlzh Ublt fbcc E ptkvcn mdkqlqcu fldr ukv E cc qb svpj yerb Ublt rk kyybrpb jk ukv nkr j flpjb ukvd jeab Tbdb p ftu Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Tlmmu qdero ab nkfr Zlr j rkjtero qdero ab nkfr Ckwb ep jkk tlmmu jk qdero ab nkfr Zlr j rkjtero qdero ab nkfr E plen qdero ab nkfr Zlr j rkjtero qdero ab nkfr Ckwb ep jkk tlmmu jk qdero ab nkfr Zlr j rkjtero qdero ab nkfr E plen Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Tlmmu qdero ab nkfr Zlr j rkjtero qdero ab nkfr Ckwb ep jkk tlmmu jk qdero ab nkfr Zlr j rkjtero qdero ab nkfr E plen Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb l dkka fejtkvj l dkky Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb tlmmerbpp ep jtb jdvjt Qbzlvpb E a tlmmu Zclm lckro ey ukv hrkf ftlj tlmmerbpp ep jk ukv Qbzlvpb E a tlmmu Zclm lckro ey ukv ybbc cehb jtlj p ftlj ukv flrrl nk";
var bg;

var ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
var LETTERS = ALPHABET.split('');
var ENGLISH = {
  A: 0.08167,
  B: 0.01492,
  C: 0.02782,
  D: 0.04253,
  E: 0.12702,
  F: 0.02228,
  G: 0.02015,
  H: 0.06094,
  I: 0.06966,
  J: 0.00153,
  K: 0.00772,
  L: 0.04025,
  M: 0.02406,
  N: 0.06749,
  O: 0.07507,
  P: 0.01929,
  Q: 0.00095,
  R: 0.05987,
  S: 0.06327,
  T: 0.09056,
  U: 0.02758,
  V: 0.00978,
  W: 0.02361,
  X: 0.0015,
  Y: 0.01974,
  Z: 0.00074
};

// Debounce function, courtesy of
// http://davidwalsh.name/function-debounce
// Currently, used exclusively for window resize.
var debounce = function (func, wait, immediate) {
  var timeout;
  return function () {
    var context = this,
      args = arguments;
    var later = function () {
      timeout = null;
      if (!immediate) func.apply(context, args);
    };
    var callNow = immediate && !timeout;
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    if (callNow) func.apply(context, args);
  };
};

var buildFrequencyMap = function () {
  var inputString = $("#input").val().replace(/[^A-Za-z]/g, "").toUpperCase();
  var totalCharCount = inputString.length;

  // Create a zeroed-out frequency map.
  var freqMap = LETTERS.reduce(function (frequencies, letter) {
    frequencies[letter] = 0;
    return frequencies;
  }, {});

  // If the input is empty, return all zeroes early so we can save work
  // and avoid trying to divide by zero later on.
  if (totalCharCount === 0) {
    return freqMap;
  }

  // Count all the letters
  var countMap = inputString.split('').reduce(function (counts, letter) {
    counts[letter] = counts[letter] ? counts[letter] + 1 : 1;
    return counts;
  }, {});

  // frequency = count/total for each letter;
  Object.keys(countMap).forEach(function (letter) {
    freqMap[letter] = countMap[letter] / totalCharCount;
  });

  return freqMap;
};

var processPlainText = function () {
  var freqMap = buildFrequencyMap();
  bg.updateUserData(freqMap);
  processSubstitutions();
};

var processSubstitutions = function () {
  if (bg) {
    var STR = $("#input").val().replace(/[^A-Za-z]/g, " ");

    var substMap = bg.getSubstMap();

    LETTERS.forEach(function (letter) {
      if (substMap[letter]) {
        STR = STR.replace(new RegExp(letter + "(?!" + letter + "*</>)", "g"), "<>" + substMap[letter] + "</>");
        STR = STR.replace(new RegExp(letter.toLowerCase() + "(?!</>)", "g"), "<>" + substMap[letter].toLowerCase() + "</>");
      }
    });

    STR = STR.replace(/<>/g, "<span>");
    STR = STR.replace(/<\/>/g, "</span>");
    $("#output").html("<div>" + STR + "</div>");
  }
};

var BarGraph = function () {

  /* DOM stuff */
  this.margin = {
    top: 10,
    right: 10,
    bottom: 44,
    left: 40
  };

  this.container = d3.select("#d3chart");

  /* Data */
  this.user_data = LETTERS.map(function (letter) {
    return {
      letter: letter,
      frequency: 0
    };
  });

  this.english_data = LETTERS.map(function (letter) {
    return {
      letter: letter,
      frequency: ENGLISH[letter]
    };
  });

  /* D3 */
  // We use two scales because we have two domain orderings
  var letterScale = d3.scale.ordinal().rangeRoundBands([0, this.getWidth()], 0.2);
  this.userLetterScale = letterScale.copy().domain(LETTERS);
  this.englishLetterScale = letterScale.copy().domain(LETTERS);

  this.freqScale = d3.scale.ordinal().domain([0, 1]);

  this.yScale = d3.scale.linear().range([this.getHeight(), 0]);

  this.xAxis = d3.svg.axis()
    .scale(this.englishLetterScale)
    .orient("bottom");

  this.yAxis = d3.svg.axis()
    .scale(this.yScale)
    .orient("left")
    .ticks(5, "%");

  this.freqScale.rangeRoundBands([0, this.userLetterScale.rangeBand()]);

};

BarGraph.prototype.getHeight = function () {
  return this.container.property("offsetHeight") - this.margin.top - this.margin.bottom;
};

BarGraph.prototype.getWidth = function () {
  return this.container.property("offsetWidth") - this.margin.left - this.margin.right;
};

BarGraph.prototype.getZippedData = function (override) {
  var user_data = override || this.user_data;
  return user_data.map(function (_, i) {
    return {
      user: user_data[i],
      english: this.english_data[i]
    };
  }, this);
};

BarGraph.prototype.getSubstMap = function () {
  return this.user_data.reduce(function (map, d, i) {
    map[d.letter] = this.english_data[i].letter;
    return map;
  }.bind(this), {});
};

BarGraph.prototype.updateSubstMap = function (substMap) {
  this.english_data = this.user_data.map(function (d) {
    return {
      letter: substMap[d.letter],
      frequency: ENGLISH[substMap[d.letter]]
    };
  });
  this.render();
};

BarGraph.prototype.updateUserData = function (frequencies) {
  this.user_data.forEach(function (d) {
    d.frequency = frequencies[d.letter];
  });
  this.render();
};

BarGraph.prototype.reorder = function () {

  this.svg.selectAll('.letter').data(this.getZippedData());

  /* reorder the domains */
  this.userLetterScale.domain(this.user_data.map(function (d) {
    return d.letter;
  }));
  this.englishLetterScale.domain(this.english_data.map(function (d) {
    return d.letter;
  }));

  /* animate rearranging the elements */
  var transition = this.svg.transition().duration(750);

  transition.selectAll(".letter")
    .attr("transform", function (d) {
      return "translate(" + this.userLetterScale(d.user.letter) + "," + this.getHeight() + ") scale(1, -1)";
    }.bind(this));

  transition.selectAll(".dragletter")
    .attr("transform", function (d) {
      return "translate(" + this.userLetterScale(d.user.letter) + ",0)";
    }.bind(this));

  transition.select(".x.axis")
    .call(this.xAxis);

  transition.each("end", function () {

    /* resort the elements in the DOM */
    this.svg.selectAll(".letter")
      .sort(function (a, b) {
        return this.englishLetterScale(a.english.letter) - this.englishLetterScale(b.english.letter);
      }.bind(this));

    this.svg.selectAll(".dragletter")
      .sort(function (a, b) {
        return this.userLetterScale(a.user.letter) - this.userLetterScale(b.user.letter);
      }.bind(this));

    /* note: no need to manually resort .x.axis, as the xAxis call does
     * that for us
     */

    /* the call to drag uses the ordering. so reattach that here */
    this.svg.select('.x1.axis').selectAll('.dragletter').call(this.drag);

    /* rerender just because */
    this.render();
    processSubstitutions();

  }.bind(this));

};

BarGraph.prototype.handleSortChange = function (changeEvent) {
  var sortFun;
  var sortType = changeEvent.target.value;

  if (sortType === "alphabetic") {
    sortFun = function (a, b) {
      return (a.letter.charCodeAt() - b.letter.charCodeAt());
    };
  } else if (sortType === "frequency") {
    sortFun = function (a, b) {
      // we do b-a rather than a-b because the values we're examining
      // are < 1
      return (b.frequency - a.frequency);
    };
  } else {
    return;
  }

  // cache the english -> user mapping
  var substMap = this.english_data.reduce(function (map, d, i) {
    map[d.letter] = this.user_data[i];
    return map;
  }.bind(this), {});

  // reorder the english data
  this.english_data = this.english_data.sort(sortFun);

  // reorder users based on the preserved mapping
  this.user_data = this.english_data.map(function (d) {
    return substMap[d.letter];
  });

  this.reorder();
};

BarGraph.prototype.resize = function () {
  this.container.select('svg').attr({
    "width": this.getWidth() + this.margin.left + this.margin.right,
    "height": this.getHeight() + this.margin.top + this.margin.bottom
  });
};

//BarGraph.prototype.createScales = function () {
//};

BarGraph.prototype.createDragBehavior = function () {
  var drag = d3.behavior.drag();

  var tempdata;

  var outline = this.svg.append("rect")
    .attr("class", "outline")
    .attr("visibility", "hidden")
    .attr("height", this.getHeight())
    .attr("width", this.userLetterScale.rangeBand());

  drag.on('dragend', function () {
    outline.attr("visibility", "hidden");
    this.svg.classed("dragging", false);
    if (tempdata) {
      this.user_data = tempdata;

      this.userLetterScale.domain(this.user_data.map(function (d) {
        return d.letter;
      }));
      this.svg.selectAll(".dragletter")
        .attr("transform", function (d) {
          return "translate(" + this.userLetterScale(d.user.letter) + ",0)";
        }.bind(this));

      this.reorder();
      tempdata = undefined;
    }
  }.bind(this));

  drag.on('drag', function (d, i) {

    this.svg.classed("dragging", true);

    /* find the target */
    var xPos = d3.event.x;
    var leftEdges = this.userLetterScale.range();
    var width = this.userLetterScale.rangeBand();
    var j;

    // There's gotta be a better way to do this. We're looking for the
    // first value in leftEdges such that that value plus the the width
    // of each element matches the cursor position
    for (j = 0; xPos > (leftEdges[j] + width); j++) {}
    j = Math.min(j, leftEdges.length - 1);

    /* move the source */
    var source = this.svg.select("#userletter-" + d.user.letter);
    var coords = source.attr("transform").replace(/[A-Za-z()]/g, '').split(',');
    var originx = this.userLetterScale(d.user.letter);
    var x = parseInt(coords[0]) + d3.event.dx;
    var y = parseInt(coords[1]) + d3.event.dy;
    console.log(d3.event.dx, d3.event.dy);
    //var x = d3.event.x;
    //var y = d3.event.y;
    source.attr("transform", "translate(" + x + "," + y + ")");

    /* swap em! This is a deep clone. Do we need a deep clone? */
    tempdata = this.user_data.map(function (d) {
      return jQuery.extend(true, {}, d);
    });

    var swap = tempdata[i];
    tempdata[i] = tempdata[j];
    tempdata[j] = swap;

    outline.attr({
      "visibility": "visible",
      "transform": "translate(" + (this.userLetterScale(this.user_data[j].letter) + 0.5) + ",0)"
    });

    /* re-size the letters */
    /* note: this seems pretty inefficient. We're binding all the data
     * for all the letters and resizing everything, and we're doing it
     * for nearly every pixel moved.
     */
    this.svg.selectAll('.letter').data(this.getZippedData(tempdata));

    this.svg.selectAll('.letter').selectAll("rect")
      .data(function (d) {
        return [d.english, d.user];
      })
      .attr("height", function (d, i) {
        return this.getHeight() - this.yScale(d.frequency);
      }.bind(this));

  }.bind(this));

  return drag;
};

BarGraph.prototype.init = function () {
  this.svg = this.container.append("svg")
    .append("g")
    .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");

  this.resize();

  this.svg.append("g")
    .attr({
      "class": "x axis",
      "transform": "translate(0," + (this.getHeight() + 24) + ")"
    })
    .call(this.xAxis)
    .selectAll("text")
    .attr({
      "class": "english",
      "y": 28 // this isn't doing anything?
    });

  var userLetters = this.svg.append("g")
    .attr({
      "class": "x1 axis",
      "transform": "translate(" + this.userLetterScale.rangeBand() / 2 + "," + (this.getHeight() - 6) + ")"
    })
    .selectAll('g')
    .data(this.getZippedData())
    .enter().append('g')
    .attr("class", "dragletter");

  userLetters.append("rect")
    .attr({
      //"class": "btn btn-primary",
      "height": 24,
      "width": this.userLetterScale.rangeBand(),
      "x": -(this.userLetterScale.rangeBand() / 2),
      "y": 10,
      "ry": 4,
      "rx": 4
    });

  [-3, 0, 3].forEach(function (offset) {
    userLetters.append("line")
      .attr({
        "x1": offset,
        "x2": offset,
        "y1": 26,
        "y2": 32
      });
  });

  userLetters.append("text")
    .attr("dy", ".71em")
    .attr("y", 14)
    .attr("class", "user")
    .style("text-anchor", "middle")
    .text(function (d, i) {
      return d.user.letter;
    });

  $("#sort-toggle button").on("change input click", this.handleSortChange.bind(this));
  $("#controls-toggle button").on("change input click", function (changeEvent) {
    var controlType = changeEvent.target.value;
    $(".controls-mode").hide();
    $(".controls-mode#mode-" + controlType).show();
  });
  $("#controls-toggle button#sort").click();

  this.svg.append("g")
    .attr("class", "y axis")
    .call(this.yAxis)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
    .text("Frequency");

  //this.svg.append("g")
    //.attr("class", "bars")
    //.selectAll(".letter")
  this.svg.selectAll(".letter")
    .data(this.getZippedData())
    .enter().append("g")
    .attr("class", "letter")
    .attr("transform", function (d) {
      return "translate(" + this.userLetterScale(d.user.letter) + "," + this.getHeight() + ") scale(1, -1)";
    }.bind(this));

  this.svg.selectAll('.letter').selectAll("rect")
    .data(function (d) {
      return [d.english, d.user];
    })
    .enter().append("rect")
    .attr("class", function (d, i) {
      return (i === 0) ? "english" : "user";
    })
    .attr("width", this.freqScale.rangeBand())
    .attr("x", function (d, i) {
      return this.freqScale(i);
    }.bind(this));


  this.drag = this.createDragBehavior();
  this.svg.select('.x1.axis').selectAll('.dragletter').call(this.drag);

};

BarGraph.prototype.shift = function (amt) {
  // Boy, there is no way this is remotely close to the most efficient
  // way to do this.
  var frequencies = this.user_data.reduce(function (freqs, d) {
    freqs[d.letter] = d.frequency;
    return freqs;
  }, {});

  this.user_data = this.english_data.map(function (english) {
    var i = (LETTERS.indexOf(english.letter) + amt) % 26;
    var letter = LETTERS[i];
    return {
      letter: letter,
      frequency: frequencies[letter]
    };
  });

  this.reorder();
};

BarGraph.prototype.randomize = function () {
  this.user_data = d3.shuffle(this.user_data);
  this.reorder();
};

BarGraph.prototype.render = function () {
  if (!this.svg || !this.user_data || !this.english_data) {
    return false;
  }

  var data = this.getZippedData();

  this.yScale.domain([0, d3.max(data, function (d) {
    var maxValue = Math.max(d.english.frequency, d.user.frequency);

    // Round to the nearest 10% ?
    //return Math.ceil(maxValue*10)/10;
    //
    return maxValue;
  })]);

  this.svg.select(".y.axis")
    .call(this.yAxis);

  this.svg.select(".x.axis")
    .call(this.xAxis);

  this.svg.select(".x1.axis")
    .data(data)
    .selectAll(".dragletter")
    .attr("id", function (d, i) {
      return "userletter-" + d.user.letter;
    })
    .attr("transform", function (d, i) {
      return "translate(" + this.userLetterScale(d.user.letter) + ",0)";
    }.bind(this))
    .sort(function (a, b) {
      return this.userLetterScale(a.user.letter) - this.userLetterScale(b.user.letter);
    }.bind(this));

  this.svg.selectAll('.letter').data(data);

  this.svg.selectAll('.letter').selectAll("rect")
    .data(function (d) {
      return [d.english, d.user];
    })
    .attr("height", function (d) {
      return this.getHeight() - this.yScale(d.frequency);
    }.bind(this));

  return true;
};

$(document).ready(function () {
  bg = new BarGraph();
  bg.init();
  bg.render();

  /*
   *$(window).on('resize', debounce(function () {
   *  bg.resize();
   *  bg.createScales();
   *  bg.render();
   *}, 200));
   */

  $("#input").on("input", processPlainText);

  $("#shift-left").on("click", function () {
    var shiftAmt = parseInt($("#shiftAmt").val()) + 1;
    shiftAmt = shiftAmt % 26;
    if (shiftAmt < 0) shiftAmt += 26;
    $("#shiftAmt").val(shiftAmt);
    bg.shift(shiftAmt);
  });
  $("#shift-right").on("click", function () {
    var shiftAmt = parseInt($("#shiftAmt").val()) - 1;
    shiftAmt = shiftAmt % 26;
    if (shiftAmt < 0) shiftAmt += 26;
    $("#shiftAmt").val(shiftAmt);
    bg.shift(shiftAmt);
  });

  $(".load-message#easy").click(function () {
    $('#input').val(message1).trigger('input');
  });

  $(".load-message#hard").click(function () {
    $('#input').val(message2).trigger('input');
  });

  $("#fillRand").click(function () {
    bg.randomize();
  });
  $(".reset-simulation").click(function () {
    $("#shiftAmt").val(0);
    bg.shift(0);
  });

  processPlainText();
  $("input").keyup(processSubstitutions);
  $(".btn-group button").button();
});
