- require 'census_helper'
- homepage_data = {courses: @recent_courses}
- homepage_data[:valid_grades] = Section.valid_grades
- homepage_data[:stageExtrasScriptIds] = Script.stage_extras_script_ids
- homepage_data[:topCourse] = @top_course
- homepage_data[:hasFeedback] = @has_feedback
- homepage_data[:isEnglish] = @is_english
- homepage_data[:locale] = Script.locale_english_name_map[request.locale]

- if current_user
  - homepage_data[:providers] = current_user.providers
  - if current_user.teacher?
    - homepage_data[:hocLaunch] = DCDO.get('hoc_launch', CDO.default_hoc_launch)
    - homepage_data[:isTeacher] = true
    - homepage_data[:joined_sections] = @student_sections
    - homepage_data[:announcement] = DCDO.get('announcement_override', nil)
    - if !current_user.donor_teacher_banner_dismissed
      - donor_banner_name = current_user.donor_teacher_banner_name
    - else
      - donor_banner_name = @force_donor_teacher_banner
    - show_census_banner = !!(!donor_banner_name && current_user.show_census_teacher_banner?)
    - homepage_data[:showCensusBanner] = show_census_banner
    - homepage_data[:hiddenScripts] = current_user.get_hidden_script_ids
    - homepage_data[:donorBannerName] = donor_banner_name
    - if show_census_banner
      %script{type: "text/javascript", src: "https://maps.googleapis.com/maps/api/js?client=#{CDO.google_maps_client_id}&sensor=true&libraries=places,geometry&v=3.7"}
      - teachers_school = current_user.school_info.school
      - school_stats = SchoolStatsByYear.where(school_id: teachers_school.id).order(school_year: :desc).first
      - homepage_data[:ncesSchoolId] = teachers_school.id
      - homepage_data[:censusQuestion] = school_stats.try(:has_high_school_grades?) ? "how_many_20_hours" : "how_many_10_hours"
      - homepage_data[:currentSchoolYear] = current_census_year
      - homepage_data[:teacherName] = current_user.name
      - homepage_data[:teacherId] = current_user.id
      - homepage_data[:teacherEmail] = current_user.email
    - elsif donor_banner_name
      - homepage_data[:teacherFirstName] = current_user.short_name
      - homepage_data[:teacherSecondName] = current_user.second_name
      - homepage_data[:teacherId] = current_user.id
      - homepage_data[:teacherEmail] = current_user.email
      - teachers_school = current_user.last_complete_school_info.school
      - homepage_data[:ncesSchoolId] = teachers_school.id
      - homepage_data[:schoolAddress1] = teachers_school.address_line1
      - homepage_data[:schoolAddress2] = teachers_school.address_line2
      - homepage_data[:schoolAddress3] = teachers_school.address_line3
      - homepage_data[:schoolCity] = teachers_school.city
      - homepage_data[:schoolState] = teachers_school.state
      - homepage_data[:schoolZip] = teachers_school.zip
  - else
    - homepage_data[:sections] = @student_sections
    - homepage_data[:isTeacher] = false
    - homepage_data[:studentId] = current_user.id
  - homepage_data[:canViewAdvancedTools] = !(current_user.under_13? && current_user.terms_version.nil?)

- content_for(:head) do
  %script{src: minifiable_asset_path('js/home/_homepage.js'), data: {homepage: homepage_data.to_json}}

-# Components generated by HAML which might be pulled in and displayed by the React model.
.hiddenComponents{style: "display: none"}
  #flashes
    = show_flashes.html_safe

.clear{style: "clear: both"}

-# In-page reminders and surveys
- if current_user
  - if current_user.teacher?
    #teacher_reminders
      - unless current_user.accepted_latest_terms?
        = render template: 'api/accept_terms_reminder'
        = render partial: 'layouts/terms_interstitial'
      - if show_nps_survey? SurveyResult::NET_PROMOTER_SCORE_2019
        = render partial: 'home/survey_nps'
      - elsif show_diversity_survey? SurveyResult::DIVERSITY_2019
        = render partial: 'home/survey_diversity'

#homepage-container

#workshop-links
  -if can? :read, Pd::Application::ApplicationBase
    %h1
      Application Dashboard
    = link_to pd_application_dashboard_path do
      %h3
        Manage Applications
  -if can? :read, Pd::Workshop
    %h1
      Workshop Dashboard
    %a{href:'/pd/workshop_dashboard'}
      %h3
        Manage PD Workshops
    -if current_user.permission?(UserPermission::WORKSHOP_ADMIN)
      = link_to pd_workshop_admins_path do
        %h3
          Directory for Workshop Admins

:javascript

  $(document).ready(function() {
    window.cleverTakeoverManager = new CleverTakeoverManager(#{takeover_manager_options_json});
  });
