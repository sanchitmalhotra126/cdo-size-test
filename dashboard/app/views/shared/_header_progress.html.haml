.header_level
  %div{class: 'header_level_container'}
    - @game_script_levels ||= (@stage && @stage.script_levels.includes(:script).joins(:level)) || @script.script_levels_from_game(@game.id)
    - game_levels = current_user ? current_user.levels_from_script(@script, @game.id, @stage) : @game_script_levels
    - script_data = { |
      title: stage_title(@script, @stage || @game), |
      levels: game_levels.map do |sl| |
        completion_status, link = level_info(current_user, sl); |
        {displayText: sl.level_display_text, status: completion_status, link: link, unplugged: !!sl.level.unplugged?, assessment: !!sl.assessment} |
      end} |
    - script_data[:finishLink] = {text: t('nav.header.finished_hoc'), href: hoc_finish_url(@script)} if @script.hoc?

    .header_text
    .progress_container
    .header_finished_link
    :javascript
      var scriptData = #{script_data.to_json};
      var currentLevelIndex = #{@script_level.stage_or_game_position - 1};
      $('.header_text').html(scriptData.title);
      if (scriptData.finishLink) {
        $('.header_finished_link').append($('<a>').attr('href', scriptData.finishLink.href).text(scriptData.finishLink.text));
      }
      var progressContainer = $('.progress_container');
      scriptData.levels.forEach(function(level, index, levels) {
        var defaultClass = level.assessment ? 'puzzle_outer_assessment' : 'puzzle_outer_level';
        var link = $('<a>').attr('href', level.link).addClass('level_link').addClass(level.status).text(level.displayText);
        if (level.unplugged) {
          link.addClass('unplugged_level');
        }
        var div = $('<div>').addClass(index === currentLevelIndex ? 'puzzle_outer_current' : defaultClass).append(link);
        if (index === levels.length - 1) {
          div.addClass('last');
        }
        progressContainer.append(div).append('\n');
      });
    - if @script.trophies
      - if current_user
        - progress = current_user.progress(@script)
        %a.header_trophy_link{href: '#', onclick: 'return handlePopupClick(true);'}
          .header_text= t(:trophies)
          .header_status_bar= progress['current_trophies']
          .header_text= "#{t(:of)} #{progress['max_trophies']}"
      - else
        %a.header_finished_link{href: root_path}
          = t('nav.header.sign_in_to_save')
    - if @script.twenty_hour? || @script.stages.to_a.count > 1
      %a.header_status_bar.level_free_play{title: t('nav.header.free_play.playlab'), href: playlab_freeplay_path}
        %i.fa.fa-rocket
      %a.header_status_bar.level_free_play{title: t('nav.header.free_play.artist'), href: artist_freeplay_path}
        %i.fa.fa-pencil
      %a.header_popup_link{href: '#', onclick: 'return handlePopupClick(false);'}
        .header_popup_link_glyph
          &#x25BC;
        .header_popup_link_text= t(:more)
