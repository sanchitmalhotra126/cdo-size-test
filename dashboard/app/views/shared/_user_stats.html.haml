- script = @script || (user && user.primary_script) || Script.twenty_hour_script
- progress = summarize_user_progress(script)
- script = script.summarize
- should_show_lesson_plan = user && user.teacher?

.user-stats-block
  - script[:stages].each do |stage|
    .game-group
      .stage
        %span
          = stage[:title]
        - if should_show_lesson_plan && stage[:lesson_plan_html_url]
          .stage-lesson-plan-link
            = link_to t('view_lesson_plan'), stage[:lesson_plan_html_url]

      .games
        - stage[:levels].each do |level|
          .level
            - status = progress.try(:levels).try(level[:id]) || 'not_tried'
            - link = "/s/#{script[:name]}/stage/#{stage[:position]}/puzzle/#{level[:position]}"
            - if params.try(:script_level_id) == "#{level[:id]}"
              - puzzle_outer_class = 'puzzle_outer_current'
            - elsif level[:kind] == 'assessment'
              - puzzle_outer_class = 'puzzle_outer_assessment'
            - else
              - puzzle_outer_class = 'puzzle_outer_level'
            %span{class: puzzle_outer_class}
              %a.level_link{ href: link, class: status }
                - if level[:kind] == 'unplugged'
                  %span.puzzle-named
                    = level[:title]
                - elsif status == 'passed' || status == 'perfect'
                  = check_mark_html
                - else
                  %span.puzzle-number
                    = level[:title]
  = render partial: 'shared/user_stats_key'

- if script[:trophies]
  %div{style: 'clear: both;'}
  #trophies
    = render partial: 'shared/concept_trophy_block', locals: {concept_progress: progress.try(:trophies), added_style: 'padding: 10px;'}
