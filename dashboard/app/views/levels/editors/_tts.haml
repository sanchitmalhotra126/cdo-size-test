.field
  = f.label :text_to_speech_overrides
  %p By default, Text-to-Speech will use the Instructions and Markdown Instructions texts as its sources. You can override them individually here if you wish to tweak the pronunciation.
  #tts-error.alert.alert-error{style: "display: none"}
    #alert-content
  .row
    .span6
      %h5 Instructions
      = f.text_area :tts_instructions_override, placeholder: '', rows: 4, class:"input-block-level"
    .span6
      %h5 Markdown Instructions
      = f.text_area :tts_markdown_instructions_override, placeholder: '', rows: 4, class:"input-block-level"
  - if CDO.use_acapela
    = f.label :voice
    %div
      %select#level_tts_voice
    %div
      %button.tts#tts-instructions{type: 'button'} Hear Instructions
      %button.tts#tts-markdown-instructions{type: 'button'} Hear Markdown Instructions
    %div
      %audio#tts-audio

:javascript
  if (#{!!CDO.acapela_login}) {
    $('button.tts').click(function () {
      var sourceText;
      switch (this.id) {
        case 'tts-instructions':
          sourceText = $("#level_tts_instructions_override").val() || $("#level_instructions").val();
          break;
        case 'tts-markdown-instructions':
          sourceText = $("#level_tts_markdown_instructions_override").val() || $('#markdown-instructions-preview').text()
          break;
      }

      $.getJSON("http://vaas.acapela-group.com/Services/UrlMaker?jsoncallback=?", {
        cl_login: "#{CDO.acapela_login}",
        cl_app: "#{CDO.acapela_ephemeral_app}",
        cl_pwd: "#{CDO.acapela_ephemeral_password}",
        req_voice: $("#level_tts_voice").val(),
        req_text: sourceText
      }, function (data) {
        $('#tts-error').hide();
        if (data.err_msg) {
          $('#alert-content').text(unescape(data.err_msg));
          $('#tts-error').show();
        }
        if (data.snd_url) {
          $("#tts-audio").attr({
            src: data.snd_url,
            controls: 'controls'
          });
        }
      });
    });

    $(document).ready(function () {
      $.getJSON("http://vaas.acapela-group.com/Services/Voices.json?jsoncallback=?", {
          cl_login: "#{CDO.acapela_login}",
          cl_app: "#{CDO.acapela_ephemeral_app}",
          fields_selection: "language_desc;speaker",
          frequency: "22050",
          technology: "HQ",
        }, function (data) {
          var voices = Object.keys(data.voices).reduce(function (prev, curr) {
            var voice = {
              speaker: data.voices[curr].speaker,
              id: curr
            }
            if (prev[data.voices[curr].language_desc]) {
              prev[data.voices[curr].language_desc].push(voice);
            } else {
              prev[data.voices[curr].language_desc] = [voice];
            }
            return prev;
          }, {});

          var optgroups = Object.keys(voices).map(function (language) {
            var options = voices[language].map(function (voice) {
              return "<option value='" + voice.id + "'>" + voice.speaker + "</option>";
            });

            return "<optgroup label='" + language + "'>" + options.join('') + "</optgroup>";
          });

          $("#level_tts_voice").html(optgroups.join(''));
          $('#level_tts_voice option[value="rosie22k"]').attr("selected",true);
        });
    });
  }
