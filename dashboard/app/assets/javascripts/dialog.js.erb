/**
 * Create a custom modal dialog box which takes a configurable options object.
 * Currently supported options include:
 * 'header' and 'body': DOM elements
 * 'redirect': redirect page after the dialog is dismissed (default: no redirect)
 * 'id': id of the dialog (default: none)
 * 'close': whether to show a close link (default: true)
 */
function Dialog(options) {
  var body = options.body;
  var header = options.header;

  var close = options.close === undefined ? true : options.close;

  var closeLink = $('<div id="x-close"/>')
      .addClass('x-close')
      .attr('data-dismiss', 'modal');
  this.div = $('<div tabindex="-1"/>').addClass('modal');
  this.div.addClass('dash_modal');
  if (options.id) {
    this.div.attr('id', options.id);
  }
  var modalBody = $('<div/>').addClass('modal-body');
  modalBody.addClass('dash_modal_body');
  if (header) {
    var modalHeader = $('<div/>').addClass('modal-header')
        .append(header);
    if (close) {
      modalHeader.append(closeLink)
    }
    this.div.append(modalHeader);
  } else if (close) {
    modalBody.append(closeLink);
  }
  modalBody.append(body);
  this.div.append(modalBody).appendTo($(document.body));

  // When the dialog is hidden, unhook the keydown event handler.
  // If onHidden option is passed in, call that as well.
  // If redirect option is passed in, redirect the page.
  // After that, close the dialog.
  $(this.div).on(
      'hidden.bs.modal',
      function() {
        if (options.onKeydown) {
          $(this.div).off('keydown', options.onKeydown);
        }
        if (options.onHidden) {
          options.onHidden();
        }
        if (options.redirect) {
          window.location.href = options.redirect;
        }
        $(this).remove();
      });

  $(this.div).on(
      'hide.bs.modal',
      function(e) {
        if (this.hideOptions) {
          // Let's have the dialog object handle hide options.
          this.processHideOptions(this.hideOptions);

          // Tell bootstrap modal dialog system not to remove this dialog yet.
          e.preventDefault();

          // Remove the options from dialog object so that when this event is called again at the
          // end of the processing of hide options, we will just let bootstrap's modal dialog
          // system clean it up like normal.
          this.hideOptions = null;
        }
      }.bind(this));

  if (options.onKeydown) {
    $(this.div).on('keydown', options.onKeydown);
  }
}

/**
 * Options is configurable with a top and left properties, both are integers.
 * Also includes staticBackdrop.  When true, modal dialog's backdrop will not
 * close the dialog when clicked.
 * The caller can also specify hideOptions, for special behavior when the dialog is dismissed.
 */
Dialog.prototype.show = function(options) {
  options = options || {};

  $(this.div).modal({
    show: true,
    // The default value for backdrop is true, meaning clicking the backdrop
    // will close the modal. A value of 'static' will not close the modal.
    backdrop: options.backdrop || true
  });

  // Store hideOptions for later use when the dialog is dismissed, inside the div itself.
  if (options.hideOptions) {
    this.hideOptions = options.hideOptions;
  }

  this.div.offset(options);
};

Dialog.prototype.hide = function() {
  $(this.div).modal('hide');
};

/**
 * This processes optional hideOptions that were provided to show().
 * At the moment it will play an animation of the dialog moving and resizing to
 * the location and dimensions of a specified div, while also fading out.
 * Certain elements are faded out more quickly so that they are gone before
 * the dialog gets too small.
 */
Dialog.prototype.processHideOptions = function(options) {

  var startCss = {};
  startCss.opacity = '1';
  startCss.left    = this.div.css('left');
  startCss.top     = this.div.css('top');
  startCss.width   = this.div.css('width');
  startCss.height  = this.div.css('height');

  // The dialog current is 640px wide but has a left margin of -320px.  We need to
  // compensate for that when determining where the animation should end at.
  var marginLeft = parseInt(this.div.css("marginLeft"));

  var endCss = {};
  endCss.opacity  = '0';
  endCss.overflow = "visible";
  endCss.left     = $(options.endTarget).offset().left - marginLeft;
  endCss.top      = $(options.endTarget).offset().top - $(window).scrollTop();
  endCss.width    = $(options.endTarget).css("width");
  endCss.height   = $(options.endTarget).css("height");

  // Fade the whole thing out slowly.
  var totalFadeTime = 500;

  // Fade some of the decorative elements quickly.
  var decorationFadeTime = 150;

  // Let's also fade the background out.
  $(".modal-backdrop").animate({opacity: 0}, totalFadeTime);

  // And a bunch of other elements
  $(".farSide").animate({opacity: 0}, decorationFadeTime);
  $("#x-close").animate({opacity: 0}, decorationFadeTime);
  $(".dialog-title").animate({opacity: 0}, decorationFadeTime);
  $(".modal-content p").animate({"font-size": "13px"}, totalFadeTime)

  // Slide the instruction box from its current position to its destination.
  $(this.div).css(startCss).animate(endCss, totalFadeTime, "swing", function() {
    // Just hide the dialog at the end.
    $(this).modal('hide');
  });

}

