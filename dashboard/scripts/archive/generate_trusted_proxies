#!/usr/bin/env ruby
# Generate the trusted proxy list from the AWS IP ranges list that amazon publishes
require_relative '../../config/environment'

# Example:
# {
# "syncToken": "1448007736",
# "createDate": "2015-11-20-09-22-15",
# "prefixes": [
#   {
#     "ip_prefix": "23.20.0.0/14",
#     "region": "us-east-1",
#     "service": "AMAZON"
#   },
#   {
#     "ip_prefix": "52.84.0.0/15",
#     "region": "GLOBAL",
#     "service": "CLOUDFRONT"
#   },
# ...

OUTPUT_FILE = Rails.root.join('config/initializers/trusted_proxies.rb')
IP_RANGES_URL = 'https://ip-ranges.amazonaws.com/ip-ranges.json'

response = JSON.parse(Net::HTTP.get(URI(IP_RANGES_URL)))

cloudfront_ips = response["prefixes"].
                 select {|ip_range| ip_range['service'] == 'CLOUDFRONT'}.
                 map {|ip_range| ip_range["ip_prefix"]}

File.open(OUTPUT_FILE, 'w') do |file|
  file.puts <<EOS
# Trust Cloudfront proxies so we get real remote IPs
# Generated by #{__FILE__} at #{Time.now} from #{IP_RANGES_URL}
# IP Range list:
#   syncToken: #{response["syncToken"]}
#   createDate: #{response["createDate"]}

Dashboard::Application.config.action_dispatch.trusted_proxies = ActionDispatch::RemoteIp::TRUSTED_PROXIES + #{cloudfront_ips.inspect}.map{ |proxy| IPAddr.new(proxy) }
EOS
end
